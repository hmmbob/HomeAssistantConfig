##########################
## Warnings on power usage on kid's bedrooms
##########################

# Reading light: the kid shouldn't be reading after bedtime, so we track
# the power usage of his bedside light with an always on switch
# Pubercave: mancave for the adolescent kid. It has a TV and PS4 that obviously
# shouldn't be on after bedtime... So let's trigger a notification if it is :)
# Minicave: same thing; the little one shouldn't be at the PC after bedtime.

- id: warn_power_usage_after_bedtime
  alias: "Notifications: Power usage na bedtijd"
  mode: queued
  trigger:
    - platform: numeric_state
      entity_id: sensor.leeslampje_zolder_power
      above: 1
      for:
        minutes: 2
      id: Leeslampje
    - platform: numeric_state
      entity_id: sensor.pubercave_power
      above: 25
      id: Pubercave
    - platform: numeric_state
      entity_id: sensor.mini_cave_power
      above: 22
      id: Minicave
  condition:
    - condition: state
      entity_id: input_boolean.notify_power_use
      state: "on"
    - condition: time
      after: input_datetime.time_leeslampje
  action:
    - service: notify.mobile_devices_adults
      data:
        title: "{{ trigger.id }}"
        message: >-
          {% if trigger.id == "Leeslampje" %}
            Het lampje op zolder staat nog aan... ({{ now().strftime('%H:%M') }}).
          {% elif trigger.id == "Minicave" %}
            De computer op de slaapkamer van T staat nog aan... ({{ now().strftime('%H:%M') }}).
          {% else %}
            De TV of PS4 op zolder staat nog aan... ({{ now().strftime('%H:%M') }}).
          {% endif %}
        data:
          tag: "{{ trigger.id }}"
          icon_url: "https://raw.githubusercontent.com/home-assistant/assets/master/logo/logo-pretty.png"

# Because the switch is always on and only used for power tracking,
# we need another way to track this switch in the logbook. We use
# 25 watts as crossover point, because the PS4 sometimes charges
# the controllers and thus consumes a bit of power.
- id: power_logging
  alias: "Power: Logging pubercave, minicave en leeslampje"
  mode: queued
  trigger:
    - platform: numeric_state
      entity_id: sensor.pubercave_power
      above: 25
      id: pubercave
    - platform: numeric_state
      entity_id: sensor.pubercave_power
      below: 25
      id: pubercave
    - platform: numeric_state
      entity_id: sensor.leeslampje_zolder_power
      above: 3
      id: leeslampje
    - platform: numeric_state
      entity_id: sensor.leeslampje_zolder_power
      below: 1
      id: leeslampje
    - platform: numeric_state
      entity_id: sensor.mini_cave_power
      above: 22
      id: minicave
    - platform: numeric_state
      entity_id: sensor.mini_cave_power
      below: 8
      id: minicave
  action:
    - choose:
        - conditions:
            condition: trigger
            id: pubercave
          sequence:
            - service: logbook.log
              data:
                name: Pubercave zolder
                entity_id: sensor.pubercave_power
                message: >-
                  {{ iif(states('sensor.pubercave_power') | float > 25, "is aan", "is uit" )}}
        - conditions:
            condition: trigger
            id: leeslampje
          sequence:
            - service: logbook.log
              data:
                name: Leeslampje zolder
                entity_id: sensor.leeslampje_zolder_power
                message: >-

        - conditions:
            condition: trigger
            id: minicave
          sequence:
            - service: logbook.log
              data:
                name: Minicave
                entity_id: sensor.mini_cave_power
                message: >-
                  {{ iif(states('sensor.mini_cave_power') | float > 22, "is aan", "is uit")}}
