#############################
## Freezer door alert       #
#############################
- id: freezer_door_left_open
  alias: "Doors: Freezer door left open"
  trigger:
    platform: state
    entity_id: binary_sensor.door_sensor_1_contact
    from: 'off'
    to: 'on'
    for:
      minutes: 2
  condition:
  - condition: state  #Only alert when wanted
    entity_id: input_boolean.notify_door_alert
    state: 'on'
  action:
  - service: script.turn_on
    entity_id: script.notify_door_open
    data:
      variables:
        title: "Vriezer"
        message: "Let op: de vriezer is nog open!"
  - service: homeassistant.turn_on
    entity_id: input_boolean.helper_freezer_door_alert
  - service: timer.start #2min timer to reannounce that door is open
    data:
      entity_id: timer.freezer_door_open

- id: freezer_door_left_open_timer
  alias: "Doors: Freezer door timer"
  trigger:
  - platform: event
    event_type: timer.finished
    event_data:
      entity_id: timer.freezer_door_open
  condition:
    - condition: state
      entity_id: 
        - binary_sensor.door_sensor_1_contact #Only if door is still open
        - input_boolean.notify_door_alert     #Only alert when wanted
      state: 'on'
  action:
  - service: script.turn_on
    entity_id: script.notify_door_open
    data:
      variables:
        title: "Vriezer"
        message: "Let op: de vriezer is nog open!"
  - service: timer.start #Start timer all over again
    data:
      entity_id: timer.freezer_door_open

#############################
## Front door alert         #
#############################
- id: front_door_left_open
  alias: "Doors: Front door left open"
  trigger:
    platform: state
    entity_id: binary_sensor.door_sensor_2_contact
    from: 'off'
    to: 'on'
    for:
      minutes: 5
  condition:
  - condition: state  #Only alert when wanted
    entity_id: input_boolean.notify_door_alert
    state: 'on'
  action:
  - service: script.turn_on
    entity_id: script.notify_door_open
    data:
      variables:
        title: "Voordeur"
        message: "Let op: de voordeur is nog open!"
  - service: homeassistant.turn_on
    entity_id: input_boolean.helper_front_door_alert
  - service: timer.start 
    data:
      entity_id: timer.front_door_open

- id: front_door_left_open_timer
  alias: "Doors: Front door timer"
  trigger:
  - platform: event
    event_type: timer.finished
    event_data:
      entity_id: timer.front_door_open
  condition:
    - condition: state  
      entity_id: 
        - binary_sensor.door_sensor_2_contact #Only if door is still open
        - input_boolean.notify_door_alert     #Only alert when wanted
      state: 'on'
  action:
  - service: script.turn_on
    entity_id: script.notify_door_open
    data:
      variables:
        title: "Voordeur"
        message: "Let op: de voordeur is nog open!"
  - service: timer.start 
    data:
      entity_id: timer.front_door_open

#############################
## Mute door alert          #
#############################
- id: notify_door_alert
  alias: "Doors: mute alerts"
  initial_state: 'on'
  trigger:
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: 'notify_door_alert'
  action:
  - service: homeassistant.turn_off
    entity_id: input_boolean.notify_door_alert
  - service: notify.mobile_devices
    data:
      message: "Waarschuwingen voor 10 min gedempt."
      title: Deur waarschuwingen
  - service: logbook.log
    data_template:
      name: "Deur waarschuwingen: " 
      message: "Deur waarschuwingen gemute {{ now().strftime('%H:%M') }}."
      domain: notify
  - delay: 00:10:00
  - service: homeassistant.turn_on
    entity_id: input_boolean.notify_door_alert
  - service: notify.mobile_devices
    data:
      message: "Waarschuwingen weer actief."
      title: Deur waarschuwingen
  - service: logbook.log
    data_template:
      name: "Deur waarschuwingen: " 
      message: "Deur waarschuwingen weer actief {{ now().strftime('%H:%M') }}."
      domain: notify

#############################
## Cancel door alerts       #
#############################
- id: cancel_freezer_door_alert
  alias: "Doors: cancel freezer alerts"
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.door_sensor_1_contact
    from: 'on'
    to: 'off'
  condition:
  - condition: state  
    entity_id: input_boolean.helper_freezer_door_alert
    state: 'on'
  action:
  - service: timer.cancel 
    data:
      entity_id: timer.freezer_door_open
  - service: notify.mobile_devices
    data:
      message: clear_notification
      data:
        tag: door_alert
  - service: homeassistant.turn_off
    entity_id: input_boolean.helper_freezer_door_alert

- id: cancel_front_door_alert
  alias: "Doors: cancel front door alerts"
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.door_sensor_2_contact
    from: 'on'
    to: 'off'
  condition:
  - condition: state  
    entity_id: input_boolean.helper_front_door_alert
    state: 'on'
  action:
  - service: timer.cancel 
    data:
      entity_id: timer.front_door_open
  - service: notify.mobile_devices
    data:
      message: clear_notification
      data:
        tag: door_alert
  - service: homeassistant.turn_off
    entity_id: input_boolean.helper_front_door_alert