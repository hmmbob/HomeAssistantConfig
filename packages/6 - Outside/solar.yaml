solar_package:
  binary_sensor:
    # Check if the current electricity prices are negative
    # on == negative price, off == positive price
    - platform: threshold
      name: "Negatieve stroomprijs"
      entity_id: sensor.zonneplan_current_electricity_tariff
      lower: 0

  input_boolean:
    # Do I want the PV to turn off automatically?
    solar_pv_off_automatic:
      name: "Zonnepanelen: Automatisch uitschakelen"
      icon: mdi:refresh-auto
    # Do I want the PV to turn off by schedule?
    solar_pv_off_schedule:
      name: "Zonnepanelen: Uitschakelen op schema"
      icon: mdi:calendar-start

  input_datetime:
    # When should PV off period stop (and turn on PV)
    solar_pv_off_end:
      name: "Zonnepanelen eindtijd uitschakeling"
      has_time: true
      has_date: true
      icon: mdi:clock-end
    # When should PV off period start (and turn off PV)
    solar_pv_off_start:
      name: "Zonnepanelen starttijd uitschakeling"
      has_time: true
      has_date: true
      icon: mdi:clock-start

  template:
    - sensor:
        - unit_of_measurement: kWh
          default_entity_id: sensor.todays_total_production_preserved
          name: Totale productie van vandaag behouden
          state: >-
            {% if states('sensor.today_s_pv_generation') not in ['unknown', 'unavailable'] %}
              {{ states('sensor.today_s_pv_generation') | float(0)  }}
            {% else %}
              {{ states('sensor.todays_total_production_preserved') | float(0) }}
            {% endif %}

  rest_command:
    # Rest Command to upload PV generation data to PVOutput
    update_pvoutput:
      url: https://pvoutput.org/service/r2/addstatus.jsp
      method: post
      content_type: "application/x-www-form-urlencoded"
      headers:
        X-Pvoutput-Apikey: !secret pvoutput_api_key
        X-Pvoutput-SystemId: !secret pvoutput_system_id
      payload: >-
        d={{now().strftime("%Y%m%d")}}
        &t={{now().strftime("%H:%M")}}
        &v1={{(states('sensor.today_s_pv_generation')|float(0))*1000}}
        &v2={{(states('sensor.pv_power')|float(0))|round(0)}}
        &v5={{states('sensor.knmi_temperatuur')|float(0)}}
        &v6={{states('sensor.on_grid_l1_voltage')|float(0)}}

  automation:
    # Automation to trigger the upload to PVOutput, using the rest_command defined above
    - id: solar_upload_to_pvoutput
      alias: "Stuur solar informatie naar PVOutput"
      description: Stuur waarden naar PVOutput
      triggers:
        - trigger: time_pattern
          minutes: /5
          seconds: "0"
      conditions:
        - condition: state
          entity_id: sensor.work_mode
          state: "Normal"
      actions:
        - action: rest_command.update_pvoutput
          data: {}
      mode: single

    - id: solar_handle_pv_off
      alias: "Beheer automatische PV-schakeling"
      description: >-
        Automatisering om mijn zonnesysteem automatisch uit te schakelen wanneer de elektriciteitsprijzen 
        onder nul liggen. Dit kan automatisch of op basis van een tijdschema via input_datetime plaatsvinden.
        Het werkt door de "grid_export_limit" in de GoodWe-integratie op 0% in te stellen, waardoor
        de omvormer geen vermogen mag produceren. Door dit op 100% in te stellen, wordt de productie
        weer herstart tot de maximale capaciteit van de omvormer.
      triggers:
        # Triggers for automatic switching
        - trigger: state
          entity_id:
            - binary_sensor.negatieve_stroomprijs
          attribute: position
          to: below
          from: above
          id: automatic_start
          variables:
            message: "Je zonnepanelen zijn automatisch uitgeschakeld omdat de stroomprijs negatief is."
        - trigger: state
          entity_id:
            - binary_sensor.negatieve_stroomprijs
          attribute: position
          to: above
          from: below
          id: automatic_stop
          variables:
            message: "Je zonnepanelen zijn weer ingeschakeld omdat de stroomprijs positief is."
        # Triggers for scheduled switching
        - trigger: time
          at: input_datetime.solar_pv_off_start
          id: scheduled_start
          variables:
            message: "Je zonnepanelen zijn uitgeschakeld op basis van je schedule."
        - trigger: time
          at: input_datetime.solar_pv_off_end
          id: scheduled_stop
          variables:
            message: "Je zonnepanelen zijn weer ingeschakeld op basis van je schedule."
      conditions:
        - alias: Controleer of omvormer operationeel is
          condition: state
          entity_id: sensor.work_mode
          state: "Normal"
      actions:
        - alias: Kies actie op basis van triggertype
          choose:
            - conditions:
                - condition: trigger
                  id: automatic_start
              sequence:
                - if:
                    - alias: Controleer of automatisch uitschakelen is toegestaan
                      condition: state
                      entity_id: input_boolean.solar_pv_off_automatic
                      state: "on"
                  then:
                    - alias: Stel terugleverlimiet in op 0 procent
                      action: number.set_value
                      target:
                        entity_id: number.grid_export_limit
                      data:
                        value: "0"
                  else:
                    - stop: "Gestopt omdat automatisch aan/uit schakelen niet is ingeschakeld"
            - conditions:
                - condition: trigger
                  id: automatic_stop
              sequence:
                - if:
                    - alias: Controleer of automatisch inschakelen is toegestaan
                      condition: state
                      entity_id: input_boolean.solar_pv_off_automatic
                      state: "on"
                  then:
                    - alias: Stel terugleverlimiet in op 100 procent
                      action: number.set_value
                      target:
                        entity_id: number.grid_export_limit
                      data:
                        value: "100"
                  else:
                    - stop: "Gestopt omdat automatisch aan/uit schakelen niet is ingeschakeld"
            - conditions:
                - condition: trigger
                  id: scheduled_start
              sequence:
                - if:
                    - alias: Controleer of gepland uitschakelen is toegestaan
                      condition: state
                      entity_id: input_boolean.solar_pv_off_schedule
                      state: "on"
                  then:
                    - alias: Stel terugleverlimiet in op 0 procent
                      action: number.set_value
                      target:
                        entity_id: number.grid_export_limit
                      data:
                        value: "0"
                  else:
                    - stop: "Gestopt omdat gepland aan/uit schakelen niet is ingeschakeld"
            - conditions:
                - condition: trigger
                  id: scheduled_stop
              sequence:
                - if:
                    - alias: Controleer of gepland inschakelen is toegestaan
                      condition: state
                      entity_id: input_boolean.solar_pv_off_schedule
                      state: "on"
                  then:
                    - alias: Stel terugleverlimiet in op 100 procent
                      action: number.set_value
                      target:
                        entity_id: number.grid_export_limit
                      data:
                        value: "100"
                    - alias: Schakel gepland PV-uit schema uit
                      action: input_boolean.turn_off
                      target:
                        entity_id: input_boolean.solar_pv_off_schedule
                  else:
                    - stop: "Gestopt omdat gepland aan/uit schakelen niet is ingeschakeld"
        - alias: Stuur pushmelding over PV-status
          action: notify.mobile_app_sm_a556b
          data:
            title: "Zonnepanelen update"
            message: "{{ message }}"
            data:
              tag: "notification-solar"
              notification_icon: mdi:solar-power-variant
              ttl: 0
              priority: high
              clickAction: "/lovelace-admin/solar"
