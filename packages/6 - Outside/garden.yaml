lights_garden_package:
  light:
    - platform: group
      name: "Verlichting tuin"
      unique_id: lampen_tuin
      entities:
        - light.tuin_wandverlichting_muren
        - light.tuin_wandverlichting_schutting

  sensor:
    - platform: schedule_state
      name: Schema tuinverlichting
      default_state: "off"
      events:
        - start: "6:30"
          end: "{{ as_timestamp(states('sensor.sun_next_rising')) }}"
          end_offset: 15
          state: "on"
          condition: "{{ (states('sensor.sun_next_rising') | as_datetime | as_local).time() > today_at('06:30').time() }}"
        - start: "{{ as_timestamp(states('sensor.sun_next_setting')) }}"
          end: "23:30"
          state: "on"
    - platform: schedule_state
      name: Schema boomverlichting
      default_state: "off"
      events:
        - start: "6:30"
          end: "{{ as_timestamp(states('sensor.sun_next_rising')) }}"
          end_offset: 30
          state: "on"
          condition: "{{ (states('sensor.sun_next_rising') | as_datetime | as_local).time() > today_at('06:30').time() }}"
        - start: "{{ as_timestamp(states('sensor.sun_next_setting')) }}"
          start_offset: -30
          end: "23:30"
          state: "on"

  automation:
    - id: garden_turn_on
      alias: "Zet de tuinverlichting aan of uit"
      mode: single
      max_exceeded: silent
      triggers:
        - alias: Tuinverlichting schema is gewijzigd
          trigger: state
          entity_id: sensor.garden_lights_schedule
      conditions:
        - alias: "Is de tuinverlichting aan of uit?"
          condition: or
          conditions:
            - alias: Schema tuinverlichting is aan
              condition: state
              entity_id: sensor.garden_lights_schedule
              state: "on"
            - alias: Schema tuinverlichting is uit
              condition: state
              entity_id: sensor.garden_lights_schedule
              state: "off"
      actions:
        - alias: Bedien tuinverlichting volgens schema
          action: homeassistant.turn_{{ states('sensor.garden_lights_schedule') }}
          target:
            entity_id:
              - light.verlichting_tuin

    - id: garden_turn_on_tree_lights
      alias: "Zet de boomverlichting aan of uit"
      mode: single
      max_exceeded: silent
      triggers:
        - alias: Boomverlichting schema is gewijzigd
          trigger: state
          entity_id: sensor.tree_lights_schedule
      conditions:
        - alias: "Is de boomverlichting aan of uit?"
          condition: or
          conditions:
            - alias: Schema boomverlichting is aan
              condition: state
              entity_id: sensor.tree_lights_schedule
              state: "on"
            - alias: Schema boomverlichting is uit
              condition: state
              entity_id: sensor.tree_lights_schedule
              state: "off"
      actions:
        - alias: Bedien boomverlichting volgens schema
          action: homeassistant.turn_{{ states('sensor.tree_lights_schedule') }}
          target:
            entity_id:
              - light.tuin_spot_boom

    - id: garden_turn_on_coming_home
      alias: "Zet de tuinverlichting aan als ik thuis kom"
      mode: single
      max_exceeded: silent
      triggers:
        - alias: Poort is geopend
          trigger: state
          entity_id: binary_sensor.poort_contact
          from: "off"
          to: "on"
      conditions:
        - alias: "Zijn de lampen uit?"
          condition: state
          entity_id: light.verlichting_tuin
          state: "off"
        - alias: Zon staat onder de horizon
          condition: state
          entity_id: sun.sun
          state: "below_horizon"
      actions:
        - alias: Zet schema-override tuinverlichting op 3 uur aan
          action: schedule_state.set_override
          target:
            entity_id: sensor.garden_lights_schedule
          data:
            state: "on"
            duration: 3

    - id: backgate_alert
      alias: "Waarschuw als iemand door de poort komt of het fietsenhok opent"
      description: "Stuur waarschuwing wanneer iemand de achterdeur van de tuin binnenkomt of het fietsenhok opent"
      mode: single
      max_exceeded: silent
      trace:
        stored_traces: 20
      triggers:
        - alias: Poort of fietsenhok is geopend
          trigger: state
          entity_id:
            - binary_sensor.poort_contact
            - binary_sensor.fietsenhok_contact
          from: "off"
          to: "on"
      actions:
        - alias: "Schakel speaker in"
          action: switch.turn_on
          target:
            entity_id: switch.alarmspeaker_alarm
        # Sometimes the trigger fires multiple times in short period. The next step
        # prevents multiple alerts in combination with 'mode: single' & 'max_exceeded: silent'
        - alias: "1 minuut niets doen om stuiterende triggers te voorkomen"
          delay: "00:01:00"

    - id: "achtertuin_stream_to_kiosk"
      alias: Stream de achtertuin naar de kiosks
      mode: single
      max_exceeded: silent
      triggers:
        - alias: Persoon gedetecteerd in achtertuin
          trigger: state
          entity_id: binary_sensor.achtertuin_persoon
          from: "off"
          to: "on"
      actions:
        - alias: Toon achtertuincamera in kiosk-popup
          action: browser_mod.popup
          data:
            dismissable: true
            autoclose: true
            browser_id:
              - kiosk1
              - kiosk2
            timeout: 90000
            size: fullscreen
            content:
              type: custom:advanced-camera-card
              cameras:
                - camera_entity: camera.achtertuin_vloeiend
        - alias: Stel kiosk-schermhelderheid in op 255
          action: number.set_value
          data:
            value: "255"
          target:
            entity_id:
              - number.kiosk1_schermhelderheid
              - number.kiosk2_schermhelderheid
        - alias: "92 seconden niets doen om stuiterende triggers te voorkomen"
          delay: "00:01:32"
