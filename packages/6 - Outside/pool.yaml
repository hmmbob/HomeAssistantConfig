pool_package:
  timer:
    pool_runtime:
      name: "Zwembad looptijd"
      restore: true

  automation:
    - id: zwembadpomp_aan_op_timer
      alias: "Zwembad: Pomp aan als de timer start"
      triggers:
        - trigger: event
          event_type: timer.started
          event_data:
            entity_id: timer.pool_runtime
          id: turn_on
        - trigger: event
          event_type: timer.finished
          event_data:
            entity_id: timer.pool_runtime
          id: turn_off
      actions:
        - action: switch.{{ trigger.id}}
          target:
            entity_id: switch.zwembad_apparatuur

    - id: pool_frost_protection_forecast_check
      alias: "Zwembad: Vorstbescherming controleren"
      mode: single
      triggers:
        - trigger: time
          at: "19:00:00"
          id: evening
        - trigger: time
          at: "08:00:00"
          id: morning
      conditions:
        - condition: template
          value_template: "{{ now().month in [11, 12, 1, 2, 3] }}"
      actions:
        - action: weather.get_forecasts
          data:
            type: daily
            entity_id: weather.knmi_home
          response_variable: forecast_data
        - choose:
            - conditions:
                - condition: trigger
                  id: evening
                - condition: state
                  entity_id: switch.schedule_953401
                  state: "off"
                - condition: template
                  value_template: "{{ (forecast_data['weather.knmi_home'].forecast[0].templow | float) < 0 }}"
              sequence:
                - action: notify.mobile_app_sm_a556b
                  data:
                    title: "⚠️ Zwembad Vorstalarming"
                    message: "Temperatuur vanavond onder 0°C. Pompschema inschakelen om bevriezen te voorkomen?"
                    data:
                      tag: pool_frost_alert
                      notification_icon: mdi:pool-thermometer
                      ttl: 0
                      priority: high
                      actions:
                        - action: POOL_ENABLE_SCHEDULE
                          title: "Schema inschakelen"
                        - action: POOL_DISMISS
                          title: "Sluiten"
            - conditions:
                - condition: trigger
                  id: morning
                - condition: state
                  entity_id: switch.schedule_953401
                  state: "on"
                - condition: template
                  value_template: "{{ (forecast_data['weather.knmi_home'].forecast[0].templow | float) >= 0 }}"
              sequence:
                - action: notify.mobile_app_sm_a556b
                  data:
                    title: "☀️ Zwembad vorstrisico voorbij"
                    message: "Vorstrisico voorbij. Pompschema uitschakelen?"
                    data:
                      tag: pool_frost_alert
                      notification_icon: mdi:pool-thermometer
                      ttl: 0
                      priority: high
                      actions:
                        - action: POOL_DISABLE_SCHEDULE
                          title: "Schema uitschakelen"
                        - action: POOL_DISMISS
                          title: "Aanhouden"

    - id: pool_frost_schedule_action
      alias: "Zwembad: Vorstbeschermingsschema actie verwerken"
      mode: single
      triggers:
        - trigger: event
          event_type: mobile_app_notification_action
          event_data:
            action: POOL_ENABLE_SCHEDULE
          id: enable
        - trigger: event
          event_type: mobile_app_notification_action
          event_data:
            action: POOL_DISABLE_SCHEDULE
          id: disable
      actions:
        - action: "switch.{{ 'turn_on' if trigger.id == 'enable' else 'turn_off' }}"
          target:
            entity_id: switch.schedule_953401
        - action: notify.mobile_app_sm_a556b
          data:
            title: "✅ Zwembadschema {{ 'Ingeschakeld' if trigger.id == 'enable' else 'Uitgeschakeld' }}"
            message: "{{ 'Ingeschakeld voor vorstbescherming' if trigger.id == 'enable' else 'Uitgeschakeld - vorstrisico voorbij' }}"
            data:
              tag: pool_frost_alert
              notification_icon: mdi:check-circle
