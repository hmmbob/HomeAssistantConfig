ev_package:
  input_number:
    ev_target_soc:
      name: Streeflaadniveau auto
      min: 0
      max: 100
      step: 5
      unit_of_measurement: "%"

  utility_meter:
    ev_charged_energy:
      cycle: monthly
      name: SmartEVSE Monthly total
      source: sensor.smartevse_6360_evtotalenergycharged
      always_available: true

  template:
    - trigger:
        # This generates triggers for all changes in the entity, both in its state and its attributes.
        - alias: Trigger bij wijziging stroomtariefsensor Zonneplan
          trigger: state
          entity_id: sensor.zonneplan_current_electricity_tariff
        # This ensures the first data is filled.
        - alias: Trigger bij herladen templates voor initialisatie
          trigger: event
          event_type: event_template_reloaded
      sensor:
        - name: "Zonneplan template prijssensor"
          unique_id: zonneplan_template_price_sensor
          unit_of_measurement: "â‚¬/kWh"
          state: "{{ states('sensor.zonneplan_current_electricity_tariff') }}"
          availability: "{{ 'sensor.zonneplan_current_electricity_tariff' | has_value }}"
          attributes:
            prices_today: >
              {%- set forecast = state_attr('sensor.zonneplan_current_electricity_tariff', 'forecast') %}
              {%- set time_key = 'datetime' %}
              {%- set price_key = 'electricity_price' %}
              {%- set ns = namespace(data=[]) %}
              {%- for i in forecast | default([], true) if as_local(as_datetime(i[time_key])).date() == now().date() %}
                {%- set ns.data = ns.data + [dict(time= as_local(as_datetime(i[time_key])).isoformat(), price = i[price_key] / 10000000 )] %}
              {%- endfor %}
              {{ ns.data }}
            prices_tomorrow: >
              {%- set forecast = state_attr('sensor.zonneplan_current_electricity_tariff', 'forecast') %}
              {%- set time_key = 'datetime' %}
              {%- set price_key = 'electricity_price' %}
              {%- set ns = namespace(data=[]) %}
              {%- for i in forecast | default([], true) if as_local(as_datetime(i[time_key])).date() == (now()+timedelta(days=1)).date() %}
                {%- set ns.data = ns.data + [dict(time= as_local(as_datetime(i[time_key])).isoformat(), price = i[price_key] / 10000000 )] %}
              {%- endfor %}
              {{ ns.data }}

  automation:
    - id: ev_handle_automatic_cheapest_charge
      alias: "Laad de auto tijdens de goedkoopste uren"
      description: "Laad mijn auto automatisch op in de goedkoopste uren"
      mode: single
      triggers:
        - alias: Trigger wanneer goedkoop laden start
          trigger: state
          entity_id: sensor.ev_smart_charging_charging
          to: "on"
          id: ev_cheapest_charge_start
        - alias: Trigger wanneer goedkoop laden stopt
          trigger: state
          entity_id: sensor.ev_smart_charging_charging
          to: "off"
          id: ev_cheapest_charge_stop
      actions:
        - alias: "Bepaal actie voor starten of stoppen goedkoop laden"
          choose:
            - conditions:
                - alias: Controleer of goedkoop laden is gestart
                  condition: trigger
                  id: ev_cheapest_charge_start
                - alias: Controleer of laadmodus naar Smart moet worden gewisseld
                  not:
                    - alias: Laadmodus is niet Smart
                      condition: state
                      entity_id: select.smartevse_6360_mode
                      state: "Smart"
              sequence:
                - alias: Selecteer slimme laadmodus
                  action: select.select_option
                  target:
                    entity_id: select.smartevse_6360_mode
                  data:
                    option: Smart
                - alias: "Stuur melding dat goedkoop laden is gestart"
                  action: notify.mobile_app_sm_a556b
                  data:
                    title: "Automatisch goedkoop laden gestart"
                    message: "Automatisch laden van de auto is gestart. ({{ now().strftime('%H:%M') }})."
                    data:
                      notification_icon: mdi:ev-station
                      ttl: 0
                      priority: high
                      clickAction: "/lovelace/car"
            - conditions:
                - alias: Controleer of goedkoop laden is gestopt
                  condition: trigger
                  id: ev_cheapest_charge_stop
                - alias: Controleer of laadmodus naar Uit moet worden gewisseld
                  not:
                    - alias: Laadmodus is niet Uit
                      condition: state
                      entity_id: select.smartevse_6360_mode
                      state:
                        - "Off"
                        - "unavailable"
              sequence:
                - alias: "Kies laadoptie uit"
                  action: select.select_option
                  target:
                    entity_id: select.smartevse_6360_mode
                  data:
                    option: "Off"
                - alias: "Stuur melding dat goedkoop laden is gestopt"
                  action: notify.mobile_app_sm_a556b
                  data:
                    title: "Automatisch goedkoop laden gestopt"
                    message: "Automatisch laden van de auto is gestopt ({{ now().strftime('%H:%M') }})"
                    data:
                      notification_icon: mdi:ev-station
                      ttl: 0
                      priority: high
                      clickAction: "/lovelace/car"

    - alias: "Werk EV-verbonden helper bij op basis van stekkerstatus"
      id: "ev_set_smart_charging_connected_sensor"
      description: "Stel Smart Charging EV verbonden sensor in"
      mode: single
      triggers:
        - alias: Trigger bij wijziging EV-plugstatus
          trigger: state
          entity_id: sensor.smartevse_6360_evplugstate
      actions:
        - alias: Controleer of stekker verbonden is
          if:
            - alias: Controleer of stekker is verbonden
              condition: state
              entity_id: sensor.smartevse_6360_evplugstate
              state: "Connected"
          then:
            - alias: Zet helper EV verbonden aan
              action: switch.turn_on
              target:
                entity_id: switch.ev_smart_charging_ev_connected
          else:
            - alias: Controleer of stekker losgekoppeld is
              if:
                - alias: Controleer of stekker is losgekoppeld
                  condition: state
                  entity_id: sensor.smartevse_6360_evplugstate
                  state: "Disconnected"
              then:
                - alias: Zet helper EV verbonden uit
                  action: switch.turn_off
                  target:
                    entity_id: switch.ev_smart_charging_ev_connected

    - id: ev_create_monthly_total_notification
      alias: "Stuur een maandelijks overzicht van de laadkosten van de auto"
      description: "Maak een maandelijks overzicht van de hoeveelheid opgeladen energie voor factureringsdoeleinden"
      mode: single
      variables:
        title: Maandelijks totaal auto laden
        message: >
          This month you have charged your EV with a total of {{ states('sensor.smartevse_monthly_total') | round(1, default=0) }} kWh. 
          The total meter reading at {{now().strftime("%d-%m-%Y %H:%M")}} was {{ states('sensor.smartevse_6360_evtotalenergycharged') | round(1, default=0) }} kWh.
      triggers:
        - alias: Trigger aan einde van de dag om maandtotaal te verwerken
          trigger: time
          at: "23:59:45"
      conditions:
        - alias: "Alleen op de laatste dag van de maand"
          condition: template
          value_template: "{{ (now() + timedelta(days=1)).strftime('%-d') == '1' }}"
      actions:
        - alias: Maak permanente melding met EV maandtotaal
          action: persistent_notification.create
          data:
            notification_id: ev_monthly_total
            title: "{{ title }}"
            message: "{{ message }}"
        - alias: Verstuur e-mail met EV maandtotaal
          action: notify.email
          data:
            title: "{{ title }}"
            message: "{{ message }}"

    - id: ev_force_update_while_charging
      alias: "Forceer nieuwe Hyundai informatie tijdens het laden"
      description: "Forceer bijwerking van de Hyundai-gegevens tijdens het laden"
      mode: single
      triggers:
        - alias: Trigger elke 15 minuten tijdens laden
          trigger: time_pattern
          minutes: "/15"
      conditions:
        - alias: "Alleen wanneer we echt aan het laden zijn"
          condition: state
          entity_id: sensor.smartevse_6360_state
          state: "Charging"
      actions:
        - alias: Werk Kia UVO-gegevens geforceerd bij
          action: kia_uvo.force_update
          data:
            device_id: 5a94e1b7fbce614053e4f5b8dfd6209b
