tgtg_package:
  ##########################
  ## Too Good To Go
  ##########################
  sensor:
    - platform: tgtg
      email: !secret tgtg_username
      access_token: !secret tgtg_access_token
      refresh_token: !secret tgtg_refresh_token
      user_id: !secret tgtg_user_id
      cookie: !secret tgtg_cookie
      scan_interval: 300

  automation:
    - alias: "TGTG Notify"
      id: tgtg_notify
      description: "Notifications for TooGoodToGo"
      mode: parallel
      max: 25
      trigger:
        - platform: state
          entity_id:
            - sensor.tgtg_bakker_bart
            - sensor.tgtg_bakkerij_b_magic_box
            - sensor.tgtg_holland_barrett_magic_box
            - sensor.tgtg_oliebollenkraam
            - sensor.tgtg_zuivelhoeve
      condition: []
      action:
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ trigger.to_state.state | float >= 1 }}"
                - condition: template
                  value_template: >-
                    {{ trigger.from_state.state | float == 0 or
                    trigger.from_state.state == "unavailable" }}
              sequence:
                - service: notify.mobile_devices_adults
                  data:
                    message: >-
                      {{ trigger.to_state.attributes.friendly_name[5:] }} heeft
                      {{ trigger.to_state.state }} box(en) voor
                      {{ trigger.to_state.attributes['TGTG Price'] }}
                      tussen {{ trigger.to_state.attributes['Pickup start'] | as_timestamp | timestamp_custom('%A %H:%M') }}
                      en {{ trigger.to_state.attributes['Pickup stop'] | as_timestamp | timestamp_custom('%H:%M') }}
                    data:
                      tag: "{{ trigger.to_state.attributes.friendly_name }}"
                      clickAction: "{{ trigger.to_state.attributes['Item URL'] }}"
                      notification_icon: "mdi:package-variant"
          default: []
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ trigger.to_state.state | float == 0 }}"
              sequence:
                - service: notify.mobile_devices_adults
                  data:
                    message: clear_notification
                    data:
                      tag: "{{ trigger.to_state.attributes.friendly_name }}"
          default: []
