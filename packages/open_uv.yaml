open_uv_package:
  #############################
  ## UV Warnings              #
  #############################
  input_boolean:
    notify_uv:
      name: "Push-meldingen over UV"
      icon: mdi:white-balance-sunny
    notify_uv_voice:
      name: "Voice-meldingen over UV"
      icon: mdi:account-voice

  input_datetime:
    time_uv_warning:
      name: UV waarschuwing
      has_time: true

  template:
    ##############################
    ## UV Alert helper           #
    ##############################
    - binary_sensor:
        - name: "UV index Warning level"
          unique_id: "uv_index_warning_level"
          state: "{{ states('sensor.openuv_current_uv_index')| float(0) >= 5.0 }}"

  automation:
    ##########################
    ## Update OpenUV sensors
    ##########################
    - id: update_openuv
      alias: "Update OpenUV"
      trigger:
        - platform: time_pattern
          minutes: "/25"
        - platform: homeassistant
          event: start
      condition:
        - condition: sun
          after: sunrise
          after_offset: "+00:30:00"
          before: sunset
          before_offset: "-00:30:00"
      action:
        service: homeassistant.update_entity
        target:
          entity_id:
            - binary_sensor.openuv_protection_window
            - sensor.openuv_current_uv_index

    ##########################
    ## UV Warnings
    ##########################
    - alias: "Notifications: UV melding"
      id: notifications_uv
      trigger:
        platform: time
        at: input_datetime.time_uv_warning
      condition:
        - condition: state
          entity_id: input_boolean.notify_uv
          state: "on"
        - condition: template
          value_template: "{{ states('sensor.openuv_max_uv_index') | float(0) >= 5.0 }}"
      action:
        - choose:
            - conditions:
                - condition: time
                  weekday:
                    - sat
                    - sun
              sequence:
                - delay: "00:30:00" # Run at 08:30 in weekends
        - service: notify.mobile_devices_all
          data:
            title: "UV Waarschuwing"
            message: "Vandaag wordt zonkracht {{ states('sensor.openuv_max_uv_index') | round(1) }} verwacht. Vergeet niet te smeren!"
            data:
              tag: "notification-uv"
              icon_url: "https://raw.githubusercontent.com/home-assistant/assets/master/logo/logo-pretty.png"
        - condition: state
          entity_id: input_boolean.notify_uv_voice
          state: "on"
        - service: tts.microsoft_say
          entity_id: media_player.woonkamer
          data:
            message: "Vandaag wordt zonkracht {{ states('sensor.openuv_max_uv_index')  }} verwacht. Goed insmeren dus!"
        - delay: "00:00:04"
        - wait_template: "{{ is_state('media_player.woonkamer', 'idle') }}" # Ensure Home Hub screen is back to photo mode
        - service: media_player.turn_off
          entity_id: media_player.woonkamer
