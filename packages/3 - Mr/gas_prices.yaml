gas_prices_package:
  multiscrape:
    ##########################
    ## Gas prices sensor
    ##
    ## Just scraping the Tinq website page for the needed information
    ## URL is to their site: https://www.tinq.nl/tankstations/utrecht-atoomweg (random example)
    ## Using !secret as to somewhat keep some privacy for the exact location I scrape.
    ##########################
    - name: gasprices
      resource: !secret scrape_url_tinq
      scan_interval: 3594 # little bit less than 1hr
      timeout: 5
      sensor:
        - unique_id: benzine
          name: "Benzine"
          icon: mdi:gas-station
          select: ".taxonomy-term-Euro95 .field--name-field-prices-price-pump"
          attribute: "content"
          device_class: monetary
          unit_of_measurement: EUR

  automation:
    ##########################
    ## Gasprice notifications
    ##########################
    - id: notification_benzine_price_changed
      alias: "Verstuur melding dat de benzineprijzen gewijzigd zijn"
      triggers:
        - trigger: state
          entity_id:
            - sensor.benzine
            - input_number.benzineprijs_esso
          not_from:
            - "unknown"
            - "unavailable"
            - "none"
          not_to:
            - "unknown"
            - "unavailable"
            - "none"
      variables:
        station: "{{ 'Tinq' if trigger.entity_id == 'sensor.benzine' else 'Esso' }}"
      conditions:
        - alias: "Check if price really changed"
          condition: template
          value_template: "{{ trigger.to_state.state != trigger.from_state.state }}"
        - condition: state
          entity_id: input_boolean.vacation_mode_away
          state: "off"
      actions:
        - action: notify.mobile_app_sm_a556b
          data:
            title: >-
              {{ iif(trigger.to_state.state < trigger.from_state.state, "Benzine wordt goedkoper", "Benzine wordt duurder") }}
            message: >-
              â›½ De {{ station }} benzineprijs is {{ iif(trigger.to_state.state < trigger.from_state.state,  "gezakt.", "gestegen.") }}
              Nieuwe prijs: {{ trigger.to_state.state }}. 
              Oude prijs: {{ trigger.from_state.state }}.
            data:
              tag: benzine
              channel: benzine
              notification_icon: mdi:gas-station

    - id: update_benzineprijs
      alias: "Werk de Esso benzine prijs bij"
      triggers:
        trigger: time
        at:
          - "06:45:00"
          - "18:45:00"
      conditions: []
      actions:
        - delay: "{{ range(30*60) | random }}"
          alias: "Random delay between now and 30mins"
        - action: downloader.download_file
          data:
            overwrite: true
            url: !secret scrape_url_esso
            filename: esso.png
        - action: llmvision.data_analyzer
          data:
            provider: 01JDVWVP7N8E70XMH6HMYWBCAN
            message: >-
              Wat kost Euro95 bij dit tankstation? Geef me alleen de prijs, zonder het
              euroteken en verdere tekst - echt alleen de prijs. Gebruik een . als
              decimaalteken.
            image_file: /config/downloads/esso.png
            sensor_entity: input_number.benzineprijs_esso
            include_filename: true
            max_tokens: 1000
          response_variable: response
