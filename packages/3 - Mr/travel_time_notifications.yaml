travel_time_notifications_package:
  input_boolean:
    location_bob_travelling_home:
      name: "Bob onderweg naar huis"

  automation:
    ##########################
    ## Coming home notifications
    ##########################
    # I always connect my phone to my car through Android Auto,
    # so it's a good way to detect if I start driving. If I do
    # this outside some of my most used locations, HA will
    # ask me if I'd like to send a "coming home" message.
    # It's done by a actionable notification in the HA app.
    - id: location_ask_to_send_notification_hmmbob_left
      alias: "Vraag of we een melding moeten versturen dat Bob vertrekt"
      triggers:
        - alias: Trigger Android Auto gaat aan
          trigger: state
          entity_id: binary_sensor.sm_a556b_android_auto
          from: "off"
          to: "on"
      conditions:
        - alias: Voorwaarde omgekeerde controle
          not:
            - or:
                - alias: Controleer zone thuis
                  condition: zone
                  entity_id: device_tracker.sm_a556b
                  zone: zone.home
                - alias: Controleer zone ADR
                  condition: zone
                  entity_id: device_tracker.sm_a556b
                  zone: zone.adr
                - alias: Controleer zone AMC
                  condition: zone
                  entity_id: device_tracker.sm_a556b
                  zone: zone.amc
        - alias: "Niet uitvoeren als er al een bericht is verstuurd"
          condition: state
          entity_id: input_boolean.location_bob_travelling_home
          state: "on"
      actions:
        - alias: "Pushmelding versturen"
          action: notify.mobile_app_sm_a556b
          data:
            title: "Reistijd"
            message: "Wil je een melding versturen?"
            data:
              car_ui: true
              notification_icon: mdi:car-side
              actions:
                - action: "send_traveltime"
                  title: "Ja"
              tag: "ask-waze"
              ttl: 0
              priority: high

      # Either when I leave some pre-defined zones, or when I click
      # the actionable notification that was sent to my HA app, HA will
      # send a "coming home" persistent notification to my wife.
    - id: location_notification_hmmbob_left_work
      alias: "Verstuur melding dat Bob van het werk vertrekt"
      triggers:
        - alias: Trigger bij notificatie-actie send_traveltime
          trigger: event
          event_type: mobile_app_notification_action
          event_data:
            action: "send_traveltime"
        - alias: Trigger vertrek uit zone ADR
          trigger: zone
          entity_id: device_tracker.sm_a556b
          event: leave
          zone: zone.adr
        - alias: Trigger vertrek uit zone AMC
          trigger: zone
          entity_id: device_tracker.sm_a556b
          event: leave
          zone: zone.amc
      conditions:
        - alias: Voorwaarde tijdvenster
          condition: time
          after: "14:00:00"
          before: "19:00:00"
          weekday:
            - mon
            - tue
            - wed
            - thu
            - fri
      actions:
        - alias: Registreer dat Bob onderweg naar huis is
          action: input_boolean.turn_on
          target:
            entity_id: input_boolean.location_bob_travelling_home
        - alias: "Waze-sensor bijwerken (werkt niet automatisch bij)"
          action: homeassistant.update_entity
          entity_id: sensor.reistijd_bob_naar_huis
        - alias: "Wachten tot bijwerken klaar is"
          delay:
            seconds: 10
        - alias: Stuur reistijdmelding naar volwassenen
          action: notify.mobile_devices_adults
          data:
            title: â™¥ Bob is op weg naar huis!
            message: >
              Waze denkt dat hij om {{ (now() + timedelta(minutes=(3 + states("sensor.reistijd_bob_naar_huis") | int))).strftime("%H:%M") }} thuis is.
            data:
              alert_once: true
              car_ui: true
              clickAction: "/lovelace/locations"
              notification_icon: mdi:car-side
              persistent: false
              priority: high
              sticky: false
              tag: "waze"
              ttl: 0
        - alias: Verwijder notificaties
          action: notify.mobile_app_sm_a556b
          data:
            message: "clear_notification"
            data:
              tag: "ask-waze"
              ttl: 0
              priority: high

    - id: location_clear_traveltime_notification
      alias: "Verwijder reistijd notificatie als ik weer thuis ben"
      triggers:
        - alias: Trigger aankomst in zone thuis
          trigger: zone
          entity_id: device_tracker.sm_a556b
          event: enter
          zone: zone.home
      conditions:
        - alias: "Controleer of hij nog onderweg naar huis is"
          condition: state
          entity_id: input_boolean.location_bob_travelling_home
          state: "on"
      actions:
        - alias: Zet status onderweg naar huis uit
          action: input_boolean.turn_off
          target:
            entity_id: input_boolean.location_bob_travelling_home
        - alias: Verwijder notificaties
          action: notify.mobile_devices_adults
          data:
            message: "clear_notification"
            data:
              tag: "waze"
              ttl: 0
              priority: high
