morning_briefing_package:
  ##########################
  ## Sends a morning briefing message to my phone
  ##########################
  input_datetime:
    time_morning_briefing:
      name: Start morning briefing
      has_time: true

  template:
    - trigger:
        - platform: time_pattern
          hours: "/1"
        - platform: homeassistant
          event: start
        - platform: event
          event_type: event_template_reloaded
      action:
        - service: weather.get_forecast
          data:
            type: daily
          target:
            entity_id: weather.knmi_home
          response_variable: forecast
      sensor:
        - name: KNMI max temp vandaag
          unique_id: knmi_max_temp_vandaag
          state: "{{ forecast.forecast[0].temperature }}"
          availability: "{{ is_number(forecast.forecast[0].temperature) }}"

  automation:
    - id: morning_briefing
      alias: "System: Morning briefing"
      trigger:
        platform: time
        at: input_datetime.time_morning_briefing
      condition:
        - condition: state
          entity_id: device_tracker.sm_a526b
          state: home
      action:
        - service: notify.mobile_app_sm_a526b
          data:
            title: Good morning sunshine!
            message: |
              Vandaag komt de zon op om {{ as_timestamp(state_attr('sun.sun', 'next_rising'))  | timestamp_custom("%H:%M") }}. 
              Momenteel is het {{ state_attr('weather.knmi_home','temperature') }}C en {{ states('sensor.knmi_home_omschrijving') | lower}}.
              {{ states('sensor.knmi_home_korte_dagverwachting') }}.
              Max temperatuur wordt {{ states('sensor.knmi_max_temp_vandaag')}}C.
            data:
              tag: "morning-brief"
              notification_icon: mdi:weather-sunset-up
