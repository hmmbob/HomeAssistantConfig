vacuum_package:
  input_boolean:
    vacuum_enable_ask_for_cleaning:
      name: "Stofzuiger herinnering"
      icon: mdi:robot-vacuum

  input_datetime:
    vacuum_ask_for_cleaning_time:
      name: Stofzuiger herinnering tijdstip
      has_time: true
      has_date: false

  automation:
    ##########################
    ## Schedule
    ##########################
    - alias: "Vraag of Rocky moet stofzuigen"
      id: vacuum_ask_to_run
      variables:
        notification_service: >
          {% if is_state("device_tracker.sm_a566b", "home") and is_state("device_tracker.sm_a556b", "home") %}notify.mobile_devices_adults
          {% elif is_state("device_tracker.sm_a566b", "home") %}notify.mobile_app_sm_a566b
          {% elif is_state("device_tracker.sm_a556b", "home") %}notify.mobile_app_sm_a556b
          {% else %}notify.bogus
          {% endif %}
      triggers:
        - trigger: time
          at: input_datetime.vacuum_ask_for_cleaning_time
      conditions:
        - condition: state
          entity_id: input_boolean.vacuum_enable_ask_for_cleaning
          state: "on"
        - "{{ as_timestamp(now()) - as_timestamp(states('sensor.rocky_last_clean_start')) > 86100 }}" # 23h55
        - condition: state
          entity_id: input_boolean.vacation_mode_away
          state: "off"
      actions:
        - alias: "Vraag of Rocky een rondje moet doen"
          action: "{{ notification_service }}"
          data:
            message: "Zal ik gaan stofzuigen? ðŸ§¹ðŸ§¹"
            title: "Rocky"
            data:
              tag: vacuum
              actions:
                - action: "vacuum_start_yes"
                  title: "ðŸ§¹ Ja, graag!"
                - action: "vacuum_start_no"
                  title: "Nee, dank je."
              ttl: 0
              priority: high
              notification_icon: mdi:robot-vacuum
        - alias: "Wacht op antwoord..."
          wait_for_trigger:
            - trigger: event
              event_type: mobile_app_notification_action
              event_data:
                action: "vacuum_start_yes"
          timeout: "01:00:00"
          continue_on_timeout: false
        - alias: "Start Rocky na bevestiging"
          action: vacuum.start
          target:
            entity_id: vacuum.rocky

    - alias: "Stuur Rocky naar de vuilnisbak"
      id: vacuum_drive_to_trash
      initial_state: "on"
      triggers:
        - trigger: state
          entity_id: vacuum.rocky
          from: "cleaning"
          to: "returning"
      actions:
        - alias: "Stop Rocky before sending goto command"
          action: vacuum.stop
          entity_id: vacuum.rocky
        - delay: "00:00:02"
        - alias: "Send Rocky to the trash can"
          action: vacuum.send_command
          data:
            command: app_goto_target
            params:
              - 30301
              - 29421
          target:
            entity_id: vacuum.rocky
        - alias: "Wait for Rocky to arrive at trash can"
          wait_for_trigger:
            - trigger: state
              entity_id: vacuum.rocky
              to: "idle"
          timeout: "00:05:00"
          continue_on_timeout: false
        - action: notify.mobile_devices_adults
          data:
            message: "ðŸ§¹ Hi! Ik moet geleegd worden en sta al bij de prullenbak. Druk na het legen op mijn ðŸ  toets en ik ga terug naar mijn dock."
            title: "Rocky"
            data:
              tag: vacuum
              actions:
                - action: "vacuum_return_to_dock"
                  title: "Keer terug naar je dock"
              ttl: 0
              priority: high
              notification_icon: mdi:robot-vacuum

    - alias: "Stuur Rocky terug naar het dock"
      id: vacuum_return_to_dock
      initial_state: "on"
      triggers:
        - trigger: event
          event_type: mobile_app_notification_action
          event_data:
            action: "vacuum_return_to_dock"
      actions:
        - action: vacuum.return_to_base
          alias: "Returning to dock"
          target:
            entity_id: vacuum.rocky

    ##########################
    ## Vacuum notifications
    ##########################
    - alias: "Melding dat Rocky aan het stofzuigen is"
      id: vacuum_notification_cleaning_started
      initial_state: "on"
      triggers:
        - trigger: state
          entity_id: vacuum.rocky
          from: "docked"
          to: "cleaning"
      actions:
        - action: notify.mobile_app_sm_a556b
          data:
            title: "Rocky"
            message: "Rocky doet zijn rondje! ðŸ§¹ðŸ§¹"
            data:
              tag: vacuum
              notification_icon: mdi:robot-vacuum

    - alias: "Verwijder notificaties van Rocky"
      id: vacuum_clear_messages
      initial_state: "on"
      triggers:
        - trigger: state
          entity_id: sensor.rocky_vacuum_error
          to: "none"
        - trigger: state
          entity_id: vacuum.rocky
          from: "returning"
          to: "docked"
      actions:
        - action: notify.mobile_devices_adults
          data:
            message: clear_notification
            data:
              tag: "vacuum"
              ttl: 0
              priority: high

    ##########################
    ## Capture errors
    ##########################
    - alias: "Melding dat Rocky in foutmodus staat"
      id: vacuum_notification_error
      initial_state: "on"
      variables:
        notification_service: >
          {% if is_state("device_tracker.sm_a566b", "home") and is_state("device_tracker.sm_a556b", "home") %}notify.mobile_devices_adults
          {% elif is_state("device_tracker.sm_a566b", "home") %}notify.mobile_app_sm_a566b
          {% elif is_state("device_tracker.sm_a556b", "home") %}notify.mobile_app_sm_a556b
          {% else %}notify.bogus
          {% endif %}
      triggers:
        - trigger: state
          entity_id: sensor.rocky_vacuum_error
      conditions:
        - condition: not
          conditions:
            - condition: state
              entity_id: sensor.rocky_vacuum_error
              state: "none"
            - condition: state
              entity_id: sensor.rocky_vacuum_error
              state: "unavailable"
      actions:
        - action: "{{ notification_service }}"
          data:
            title: "Rocky heeft een probleem"
            message: "Foutmelding: {{state_translated('sensor.rocky_vacuum_error')}}"
            data:
              tag: vacuum
              ttl: 0
              priority: high
              notification_icon: mdi:robot-vacuum

    - alias: "Waarschuw als Rocky onderhoud nodig heeft"
      id: vacuum_consumable_warning
      initial_state: "on"
      mode: queued
      variables:
        consumables:
          - sensor: sensor.rocky_filter_time_left
            button: button.rocky_reset_air_filter_consumable
            name: "filter"
          - sensor: sensor.rocky_main_brush_time_left
            button: button.rocky_reset_main_brush_consumable
            name: "hoofd borstel"
          - sensor: sensor.rocky_sensor_time_left
            button: button.rocky_reset_sensor_consumable
            name: "sensor"
          - sensor: sensor.rocky_side_brush_time_left
            button: button.rocky_reset_side_brush_consumable
            name: "zijborstel"
      trigger:
        - platform: numeric_state
          entity_id:
            - sensor.rocky_filter_time_left
            - sensor.rocky_main_brush_time_left
            - sensor.rocky_sensor_time_left
            - sensor.rocky_side_brush_time_left
          below: 0
      action:
        - variables:
            triggered_sensor: "{{ trigger.entity_id }}"
            consumable: >-
              {{ consumables | selectattr('sensor', 'eq', triggered_sensor) | list | first }}
        - service: notify.mobile_app_sm_a556b
          data:
            title: "Rocky onderhoud nodig"
            message: "De {{ consumable.name }} van Rocky moet worden vervangen of schoongemaakt. Wil je de teller resetten?"
            data:
              tag: rocky_maintenance
              notification_icon: mdi:robot-vacuum
              actions:
                - action: "reset_consumable"
                  title: "Reset teller"
                - action: "ignore"
                  title: "Later"
              ttl: 0
              priority: high
        - wait_for_trigger:
            - platform: event
              event_type: mobile_app_notification_action
              event_data:
                action: "reset_consumable"
          timeout: "01:00:00"
          continue_on_timeout: false
        - choose:
            - conditions: "{{ wait.trigger is not none }}"
              sequence:
                - service: button.press
                  target:
                    entity_id: "{{ consumable.button }}"
            - conditions: "{{ wait.trigger is none }}"
              sequence:
                - service: persistent_notification.create
                  data:
                    title: "Rocky onderhoud niet gereset"
                    message: "De {{ consumable.name }} teller is niet gereset. Vergeet het niet als je onderhoud hebt gedaan!"
                    notification_id: "rocky_maintenance_{{ consumable.name }}"
