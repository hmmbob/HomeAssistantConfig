vacuum_package:
  input_boolean:
    vacuum_enable_ask_for_cleaning:
      name: "Stofzuiger herinnering"
      icon: mdi:robot-vacuum

  input_datetime:
    vacuum_ask_for_cleaning_time:
      name: Stofzuiger herinnering tijdstip
      has_time: true
      has_date: false

  automation:
    ##########################
    ## Schedule
    ##########################
    - alias: "Vacuum: Ask to have Rocky do its cleaning"
      id: vacuum_ask_to_run
      variables:
        notification_service: >
          {% if is_state("device_tracker.sm_a336b", "home") and is_state("device_tracker.sm_a526b", "home") %}notify.mobile_devices_adults
          {% elif is_state("device_tracker.sm_a336b", "home") %}notify.mobile_app_sm_a336b
          {% elif is_state("device_tracker.sm_a526b", "home") %}notify.mobile_app_sm_a526b
          {% else %}notify.bogus
          {% endif %}
      trigger:
        - platform: time
          at: input_datetime.vacuum_ask_for_cleaning_time
      condition:
        - condition: state
          entity_id: input_boolean.vacuum_enable_ask_for_cleaning
          state: "on"
        - "{{ as_timestamp(now()) - as_timestamp(states('sensor.rocky_last_clean_start')) > 86400 }}"
        - condition: state
          entity_id: input_boolean.vacation_mode_away
          state: "off"
      action:
        - alias: "Vraag of Rocky een rondje moet doen"
          service: "{{ notification_service }}"
          data:
            message: "Het is langer dan 24u geleden dat ik mijn laatste rondje heb gedaan. Zal ik gaan stofzuigen? 🧹🧹"
            title: "Rocky"
            data:
              tag: vacuum
              channel: vacuum
              actions:
                - action: "vacuum_start_yes"
                  title: "🧹 Ja, graag!"
                - action: "vacuum_start_no"
                  title: "Nee, dank je."
              ttl: 0
              priority: high
              notification_icon: mdi:robot-vacuum
        - alias: "Wacht op antwoord..."
          wait_for_trigger:
            - platform: event
              event_type: mobile_app_notification_action
              event_data:
                action: "vacuum_start_yes"
          timeout: "01:00:00"
          continue_on_timeout: false
        - alias: "Start Rocky na bevestiging"
          service: vacuum.start
          target:
            entity_id: vacuum.rocky

    - alias: "Vacuum: Drive Rocky to trash can"
      id: vacuum_drive_to_trash
      initial_state: "on"
      trigger:
        - platform: state
          entity_id: vacuum.rocky
          from: "cleaning"
          to: "returning"
      action:
        - alias: "Stop Rocky before sending goto command"
          service: vacuum.stop
          entity_id: vacuum.rocky
        - delay: "00:00:02"
        - alias: "Send Rocky to the trash can"
          service: vacuum.send_command
          data:
            command: app_goto_target
            params:
              - 30301
              - 29421
          target:
            entity_id: vacuum.rocky
        - alias: "Wait for Rocky to arrive at trash can"
          wait_for_trigger:
            - platform: state
              entity_id: vacuum.rocky
              to: "idle"
          timeout: "00:05:00"
          continue_on_timeout: false
        - service: notify.mobile_devices_adults
          data:
            message: "🧹 Hi! Ik moet geleegd worden en sta al bij de prullenbak. Druk na het legen op mijn 🏠 toets en ik ga terug naar mijn dock."
            title: "Rocky"
            data:
              tag: vacuum
              channel: vacuum
              actions:
                - action: "vacuum_return_to_dock"
                  title: "Keer terug naar je dock"
              ttl: 0
              priority: high
              notification_icon: mdi:robot-vacuum

    - alias: "Vacuum: Return to dock"
      id: vacuum_return_to_dock
      initial_state: "on"
      trigger:
        - platform: event
          event_type: mobile_app_notification_action
          event_data:
            action: "vacuum_return_to_dock"
      action:
        - service: vacuum.return_to_base
          alias: "Returning to dock"
          target:
            entity_id: vacuum.rocky
        - service: notify.mobile_devices_adults
          data:
            message: clear_notification
            data:
              tag: "vacuum"

    ##########################
    ## Notifications
    ##########################
    - alias: "Vacuum: Rocky started cleaning"
      id: vacuum_notification_cleaning_started
      initial_state: "on"
      trigger:
        - platform: state
          entity_id: vacuum.rocky
          from: "docked"
          to: "cleaning"
      action:
        - service: notify.mobile_app_sm_a526b
          data:
            title: "Rocky"
            message: "Rocky doet zijn rondje! 🧹🧹"
            data:
              tag: vacuum
              channel: vacuum
              notification_icon: mdi:robot-vacuum

    ##########################
    ## Capture errors
    ##########################
    - alias: "Vacuum: Rocky is in error mode"
      id: vacuum_notification_error
      initial_state: "on"
      # variables:
      #   notification_service: >
      #     {% if is_state("device_tracker.sm_a336b", "home") and is_state("device_tracker.sm_a526b", "home") %}notify.mobile_devices_adults
      #     {% elif is_state("device_tracker.sm_a336b", "home") %}notify.mobile_app_sm_a336b
      #     {% elif is_state("device_tracker.sm_a526b", "home") %}notify.mobile_app_sm_a526b
      #     {% else %}notify.bogus
      #     {% endif %}
      trigger:
        - platform: state
          entity_id: sensor.rocky_vacuum_error
      condition:
        - condition: not
          conditions:
            - condition: state
              entity_id: sensor.rocky_vacuum_error
              state: "none"
            - condition: state
              entity_id: sensor.rocky_vacuum_error
              state: "unavailable"
      action:
        - service: notify.mobile_app_sm_a526b
          # service: "{{ notification_service }}"
          data:
            title: "Rocky heeft een probleem"
            message: "Foutmelding: {{states('sensor.rocky_vacuum_error')}}"
            data:
              tag: vacuum
              channel: vacuum
              ttl: 0
              priority: high
              notification_icon: mdi:robot-vacuum

    - alias: "Vacuum: Clear Rocky error mode"
      id: vacuum_clear_notification_error
      description: Clear notification of Rocky error
      trigger:
        - platform: state
          entity_id: sensor.rocky_vacuum_error
          to: "none"
      action:
        - service: notify.mobile_devices_adults
          data:
            message: clear_notification
            data:
              tag: vacuum
              ttl: 0
              channel: vacuum
              priority: high
