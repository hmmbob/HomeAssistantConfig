doorbell_package:
  input_boolean:
    enable_deurbel:
      name: "Deurbel"
      icon: mdi:doorbell

  automation:
    - id: "deurbel_met_ai_beschrijving"
      alias: Deurbel met AI beschrijving
      description: Stuur een notificatie met beschrijving als iemand aanbelt
      variables:
        group: "deurbel_camera"
        tag: "{{ group + int(as_timestamp(now()))|string }}"
        title: "De deurbel gaat"
      triggers:
        - trigger: state
          entity_id: binary_sensor.voordeur_bezoeker
          from: "off"
          to: "on"
      conditions:
        - condition: state
          entity_id: input_boolean.enable_deurbel
          state: "on"
      actions:
        - parallel:
            - repeat:
                for_each: >
                  {{
                    (expand(state_attr('zone.home', 'persons'))
                    | map(attribute='attributes.source')
                    | map('replace', 'device_tracker.', 'notify.mobile_app_')
                    | list + ['notify.mobile_app_sm_a556b'])
                    | unique | list
                  }}
                sequence:
                  - alias: Send notification to notify devices
                    action: "{{ repeat.item }}"
                    data:
                      title: "{{ title }}"
                      message: "AI text wordt geladen..."
                      data:
                        image: /api/camera_proxy/camera.voordeur_vloeiend
                        clickAction: /lovelace/camera
                        tag: "{{ tag }}"
                        group: "{{ group }}"
                        notification_icon: mdi:doorbell-video
                        priority: high
                        timeout: 60
                        ttl: 0
                        visibility: public
            - sequence:
                - alias: Analyze event
                  action: ai_task.generate_data
                  response_variable: response
                  data:
                    entity_id: ai_task.google_ai_task_gemini_3_flash_preview
                    task_name: Voordeur AI analyse
                    instructions: |2-
                      Beoordeel de bijgevoegde deurbelfoto. Is het een bezorger (heeft de persoon een pakket/doos vast?) of een bezoeker?
                      Als het een bezorger is, schat dan het bedrijf in op basis van kleding (PostNL: oranje; DHL: geel; Picnic: rood/tassen)
                      en/of voertuig (PostNL: witte bus; DHL: gele bus). Antwoord kort in het Nederlands. Zeg 'Geen persoon te zien' of 'Onbekend'
                      indien nodig. Beschrijf de scene niet
                    attachments:
                      media_content_id: media-source://camera/camera.voordeur_vloeiend
                      media_content_type: application/vnd.apple.mpegurl
                      metadata:
                        title: Voordeur Vloeiend
                        thumbnail: /api/camera_proxy/camera.voordeur_vloeiend
                        media_class: video
                        children_media_class: null
                        navigateIds:
                          - media_content_type: app
                            media_content_id: media-source://camera
                - repeat:
                    for_each: >
                      {{
                        (expand(state_attr('zone.home', 'persons'))
                        | map(attribute='attributes.source')
                        | map('replace', 'device_tracker.', 'notify.mobile_app_')
                        | list + ['notify.mobile_app_sm_a556b'])
                        | unique | list
                      }}
                    sequence:
                      - alias: Update notification to notify devices
                        action: "{{ repeat.item }}"
                        data:
                          title: "{{ title }}"
                          message: "{{ response.data }}"
                          data:
                            image: /api/camera_proxy/camera.voordeur_vloeiend
                            clickAction: /lovelace/camera
                            tag: "{{ tag }}"
                            group: "{{ group }}"
                            notification_icon: mdi:doorbell-video
                            priority: high
                            timeout: 60
                            ttl: 0
                            visibility: public

    - id: "deurbel_stream_to_kiosk"
      alias: Stream de deurbel naar de kiosks
      triggers:
        - trigger: state
          entity_id: binary_sensor.voordeur_bezoeker
          from: "off"
          to: "on"
      conditions:
        - condition: state
          entity_id: input_boolean.enable_deurbel
          state: "on"
      actions:
        - action: browser_mod.popup
          data:
            dismissable: true
            autoclose: false
            browser_id:
              - kiosk1
              - kiosk2
            timeout: 60000
            size: fullscreen
            content:
              type: custom:advanced-camera-card
              cameras:
                - camera_entity: camera.voordeur_vloeiend
        - action: number.set_value
          data:
            value: "255"
          target:
            entity_id:
              - number.kiosk1_schermhelderheid
              - number.kiosk2_schermhelderheid

    - id: deurbel_turn_off_chime
      alias: Zet de deurbel boven uit na bepaalde tijd
      description: "Zet de deurbel boven uit na bepaalde tijd"
      mode: single
      triggers:
        - trigger: time
          at: "21:00:00"
          id: "off"
        - trigger: time
          at: "09:00:00"
          id: "hophop"
      conditions: []
      actions:
        - action: select.select_option
          data:
            option: "{{ trigger.id }}"
          target:
            entity_id: select.reolink_chime_boven_beltoon_bij_bezoeker
