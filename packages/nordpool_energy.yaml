nordpool_energy:
  ##########################
  ## Dynamic energy prices
  ##########################
  sensor:
    - platform: nordpool
      region: "NL"
      currency: "EUR"
      VAT: False
      precision: 3
      low_price_cutoff: 0.9
      price_in_cents: false
      price_type: kWh
      additional_costs: >
        {% set VAT = 0.21 %}
        {% set tax_kWh = 0.12599 %}
        {% set opslag = 0.0025 %}
        {{ ((current_price * VAT ) + (tax_kWh + opslag) * (1 + VAT)) | float }}

  ##############################
  ## Nordpool template sensors #
  ##############################
  template:
    - sensor:
        - name: "Nordpool Tomorrow Average"
          unique_id: nordpool_tomorrow_average
          state: "{{ average(states['sensor.nordpool'].attributes.tomorrow, 0) | round(3) }}"

    - binary_sensor:
        - name: "Negative electricity price this hour"
          unique_id: nordpool_electricity_negative_this_hour
          state: >
            {{ states('sensor.nordpool') | float(3) < 0.156 }}
          availability: >
            {{ states('sensor.nordpool') | is_number }}

        - name: "Negative electricity price today"
          unique_id: nordpool_electricity_negative_today
          state: >
            {{ state_attr("sensor.nordpool", "today") | min < 0.156 }}
          availability: >
            {{ states('sensor.nordpool') | is_number }}

        - name: "Negative electricity price tomorrow"
          unique_id: nordpool_electricity_negative_tomorrow
          state: >
            {%  if (
                  is_state_attr('sensor.nordpool','tomorrow_valid', 'false') 
                  or state_attr('sensor.nordpool', 'tomorrow') == []
                ) %}
              off
            {% else %}
              {{ state_attr("sensor.nordpool", "tomorrow") | min < 0.156 }}
            {% endif %}
          availability: >
            {{ states('sensor.nordpool') | is_number }}
  ##########################
  ## Dynamic gasprices
  ##########################
  rest:
    - resource: https://enever.nl/feed/gasprijs_vandaag.php
      scan_interval: 900
      sensor:
        - name: "Zonneplan gasprijs"
          unique_id: zonneplan_gasprijs
          value_template: "{{ ((value_json.data.0.prijsZP | float(0)) if value_json is defined else 'unavailable')  }}"
          json_attributes_path: "$.data.0"
          json_attributes:
            - "datum"
          device_class: monetary
