nordpool_energy_package:
  ##########################
  ## Dynamic energy prices
  ##########################
  sensor:
    - platform: nordpool
      region: "NL"
      currency: "EUR"
      VAT: False
      precision: 3
      low_price_cutoff: 0.9
      price_in_cents: false
      price_type: kWh
      additional_costs: >
        {% set VAT = 0.21 %}
        {% set tax_kWh = 0.12599 %}
        {% set opslag = 0.0025 %}
        {{ ((current_price * VAT ) + (tax_kWh + opslag) * (1 + VAT)) | float }}

  template:
    - sensor:
        - name: "Nordpool Today Average"
          unique_id: nordpool_today_average
          state: "{{ average(states['sensor.nordpool'].attributes.today, 0) | round(2) }}"
    - sensor:
        - name: "Nordpool Tomorrow Average"
          unique_id: nordpool_tomorrow_average
          state: "{{ average(states['sensor.nordpool'].attributes.tomorrow, 0) | round(2) }}"

    - binary_sensor:
        - name: "Negative electricity price this hour"
          unique_id: nordpool_electricity_negative_this_hour
          state: >
            {{ states('sensor.nordpool') | float(3) < 0.156 }}
          availability: >
            {{ states('sensor.nordpool') | is_number }}

        - name: "Negative electricity price today"
          unique_id: nordpool_electricity_negative_today
          state: >
            {{ state_attr("sensor.nordpool", "today") | min < 0.156 }}
          availability: >
            {{ states('sensor.nordpool') | is_number }}

        - name: "Negative electricity price tomorrow"
          unique_id: nordpool_electricity_negative_tomorrow
          state: >
            {%  if (
                  is_state_attr('sensor.nordpool','tomorrow_valid', 'false') 
                  or state_attr('sensor.nordpool', 'tomorrow') == []
                ) %}
              off
            {% else %}
              {{ state_attr("sensor.nordpool", "tomorrow") | min < 0.156 }}
            {% endif %}
          availability: >
            {{ states('sensor.nordpool') | is_number }}

  rest:
    - resource: https://enever.nl/feed/gasprijs_vandaag.php
      scan_interval: 900
      sensor:
        - name: "Zonneplan gasprijs"
          unique_id: zonneplan_gasprijs
          value_template: "{{ ((value_json.data.0.prijsZP | float(0)) if value_json is defined else 'unavailable')  }}"
          json_attributes_path: "$.data.0"
          json_attributes:
            - "datum"
          device_class: monetary

  automation:
    - alias: "Energy: Notification for negative electricity price tomorrow"
      id: energy_notifocation_negative_tomorrow
      trigger:
        platform: state
        entity_id: binary_sensor.nordpool_negative_electricity_price_tomorrow
        to: "on"
        from: "off"
      action:
        - service: notify.mobile_app_sm_a526b
          data:
            title: "Negative electricity price tomorrow"
            message: "There are one or more hour with negative electricity prices tomorrow!"
            data:
              channel: "Energy"
              importance: high
              notification_icon: "mdi:home-lightning-bolt"
              actions:
                - action: "URI"
                  title: "Check overzicht"
                  uri: "/lovelace/energy"
