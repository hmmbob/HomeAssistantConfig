bedroom_minicave_package:
  light:
    - platform: group
      name: "Verlichting Minicave"
      unique_id: lampen_minicave
      entities:
        - light.ledstrip_bureau_mini
        - light.ledstrip_bed_mini
        - light.plafondlamp_t

  input_boolean:
    notify_power_use_minicave:
      name: Waarschuwing minicave
      icon: mdi:lightbulb-on-outline

  input_datetime:
    time_poweruse_minicave:
      name: Tijd poweruse minicave
      has_time: true
    time_mini_gametime_over:
      name: Mini gametijd over
      has_time: true

  input_number:
    mini_pc_time_weekday:
      name: PC tijd mini weekdag
      min: 0
      max: 18
      step: 0.5
      icon: mdi:desktop-classic
    mini_pc_time_weekend:
      name: PC tijd mini weekend
      min: 0
      max: 18
      step: 0.5
      icon: mdi:desktop-classic

  sensor:
    - platform: history_stats
      unique_id: minicave_pc_on_today
      name: Minicave PC on today
      entity_id: binary_sensor.minicave_pc
      state: "on"
      type: time
      start: "{{ now().replace(hour=0, minute=0, second=0) }}"
      end: "{{ now() }}"
    - platform: history_stats
      unique_id: minicave_tv_on_today
      name: Minicave TV on today
      entity_id: binary_sensor.minicave_tv
      state: "on"
      type: time
      start: "{{ now().replace(hour=0, minute=0, second=0) }}"
      end: "{{ now() }}"
    - platform: history_stats
      name: Schoollaptop mini aan
      entity_id: binary_sensor.schoollaptop_t
      state: "on"
      type: time
      start: "{{ now().replace(hour=0, minute=0, second=0) }}"
      end: "{{ now() }}"

  automation:
    ## Warnings on power usage on kid's bedroom
    ## The little one shouldn't be at his PC after bedtime.
    - id: warn_power_usage_after_bedtime_minicave
      alias: "Waarschuwing dat de minicave nog stroom verbruikt"
      mode: queued
      triggers:
        - alias: PC verbruikt stroom
          trigger: numeric_state
          entity_id: sensor.mini_cave_power
          above: 80
          id: PC
        - alias: TV is ingeschakeld
          trigger: state
          entity_id: binary_sensor.minicave_tv
          to: "on"
          id: TV
        - alias: Schoollaptop is ingeschakeld
          trigger: state
          entity_id: binary_sensor.schoollaptop_t
          to: "on"
          for:
            minutes: 2
          id: Schoollaptop
      conditions:
        - alias: Stroomgebruik meldingen zijn ingeschakeld
          condition: state
          entity_id: input_boolean.notify_power_use_minicave
          state: "on"
        - alias: Na ingestelde waarschuwingstijd
          condition: time
          after: input_datetime.time_poweruse_minicave
      actions:
        - alias: Stuur notificatie naar ouders over stroomverbruik in de minicave
          action: notify.mobile_devices_adults
          data:
            title: "Minicave {{ trigger.id }}"
            message: >-
              {% if trigger.id == "PC" %}
                De computer van de mini staat nog aan... ({{ now().strftime('%H:%M') }}).
              {% elif trigger.id == "Schoollaptop" %}
                De schoollaptop van de mini staat nog aan... ({{ now().strftime('%H:%M') }}).
              {% else %}
                De TV van de mini staat nog aan... ({{ now().strftime('%H:%M') }}).
              {% endif %}
            data:
              tag: minicave
              notification_icon: mdi:home-lightning-bolt
              ttl: 0
              priority: high

    - id: warn_pc_time_over_minicave
      alias: "Waarschuwing dat de mini te lang op de PC zit"
      mode: queued
      triggers:
        - alias: PC-tijd overschreden op doordeweekse dag
          trigger: numeric_state
          entity_id: sensor.minicave_pc_on_today
          above: input_number.mini_pc_time_weekday
          id: weekday
        - alias: PC-tijd overschreden in weekend
          trigger: numeric_state
          entity_id: sensor.minicave_pc_on_today
          above: input_number.mini_pc_time_weekend
          id: weekend
        - alias: Vastgestelde gametijd voorbij
          trigger: time
          at: input_datetime.time_mini_gametime_over
          id: all_days
      conditions:
        - alias: Controle op juiste moment voor trigger
          or:
            - and:
                - '{{ trigger.id == "weekday" }}'
                - condition: time
                  weekday:
                    - mon
                    - tue
                    - wed
                    - thu
                    - fri
            - and:
                - '{{ trigger.id == "weekend" }}'
                - condition: time
                  weekday:
                    - sat
                    - sun
            - and:
                - '{{ trigger.id == "all_days" }}'
                - condition: state
                  entity_id: binary_sensor.minicave_pc
                  state: "on"
      actions:
        - alias: Knipper lampen en geef audio waarschuwing
          parallel:
            - alias: Knipper lampen rood
              sequence:
                - alias: Zet lampen rood aan
                  action: light.turn_on
                  target:
                    entity_id:
                      - light.ledstrip_bureau_mini
                      - light.plafondlamp_t
                  data:
                    color_name: red
                - alias: Wacht even
                  delay:
                    seconds: 2
                - alias: Knipper 10 keer
                  repeat:
                    count: 10
                    sequence:
                      - alias: Toggle lampen aan/uit
                        action: light.toggle
                        data: {}
                        target:
                          entity_id:
                            - light.ledstrip_bureau_mini
                            - light.plafondlamp_t
                      - alias: Wacht tussen knipperingen
                        delay:
                          seconds: 1
                          milliseconds: 500
            - alias: Speel audio waarschuwing af
              action: tts.microsoft_say
              data:
                entity_id: media_player.slaapkamer_t
                message: "Je tijd is op. Sluit je af?"
        - alias: Stuur notificatie naar mini
          action: notify.mobile_app_sm_a566b_t
          data:
            title: Tijd is om
            message: Je tijd is op. Sluit je af?
            data:
              tag: mini_pc
              notification_icon: mdi:desktop-classic
              priority: high
              ttl: 0
        - alias: Stuur notificatie naar ouders
          action: notify.mobile_devices_adults
          data:
            title: Mini's gametijd voorbij
            message: >-
              De Mini heeft nu lang genoeg achter de PC gezeten ({{ now().strftime('%H:%M') }}).
            data:
              tag: mini_pc
              notification_icon: mdi:desktop-classic
              priority: high
              ttl: 0
