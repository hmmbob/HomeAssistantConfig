batteries_package:
  automation:
    - id: battery_low_check
      alias: Wekelijkse check voor lage batterijen
      description: Controleer of een batterij leeg is
      mode: single
      triggers:
        - alias: Elke zaterdag om 12:00 voor batterijcontrole
          trigger: time
          at: "12:00:00"
          weekday:
            - "sat"
      action:
        - alias: Start controle op lage batterijen via Battery Notes
          service: battery_notes.check_battery_low

    - id: battery_low_notification
      alias: Bericht over lage batterijen
      description: Melding voor lage batterij met automatisch sluiten
      mode: queued
      variables:
        title: "{{ trigger.event.data.device_name }}"
        message: >-
          ğŸª« {{ trigger.event.data.device_name }} 
          {%- if trigger.event.data.battery_level is defined -%}
              heeft een batterijniveau van {{trigger.event.data.battery_level}}%.
          {%- else -%}
            is leeg.
          {%- endif %}
          Je hebt {{trigger.event.data.battery_quantity }}x 
          {{trigger.event.data.battery_type }} nodig om de batterij te vervangen.
        id: "{{ trigger.event.data.device_id }}"
        navigate: "/config/devices/device/{{id}}"
      triggers:
        - trigger: event
          event_type: battery_notes_battery_threshold
          event_data:
            battery_low: true
          id: low
          alias: Batterij is leeg
        - trigger: event
          event_type: battery_notes_battery_threshold
          event_data:
            battery_low: false
          id: high
          alias: Batterij is opgeladen
      actions:
        - alias: Kies melding op basis van batterijstatusevent
          choose:
            - conditions:
                - alias: Controleer of batterij laag is
                  condition: trigger
                  id: low
              sequence:
                - alias: Stuur mobiele melding voor lege batterij
                  action: notify.mobile_app_sm_a556b
                  data:
                    title: "{{title}}"
                    message: "{{message}}"
                    data:
                      notification_icon: mdi:battery-alert-variant
                      clickAction: "{{navigate}}"
                      tag: "{{id}}"
                - alias: Maak persistente melding voor lege batterij
                  action: persistent_notification.create
                  data:
                    title: "{{title}}"
                    notification_id: "{{id}}"
                    message: "{{message}} {{ '\n\n' -}} [Link naar apparaat pagina]({{navigate}})"
            - conditions:
                - alias: Controleer of batterij weer volledig is
                  condition: trigger
                  id: high
              sequence:
                - alias: Verwijder mobiele melding voor deze batterij
                  action: notify.mobile_app_sm_a556b
                  data:
                    message: "clear_notification"
                    data:
                      tag: "{{id}}"
                - alias: Sluit persistente batterijmelding
                  action: persistent_notification.dismiss
                  data:
                    notification_id: "{{id}}"

    - id: battery_replaced
      alias: Batterijen vervangen
      description: Markeer de batterij als vervangen
      mode: queued
      triggers:
        - alias: Batterijniveau is gestegen na vervanging
          trigger: event
          event_type: battery_notes_battery_increased
      actions:
        - alias: Markeer batterij als vervangen in Battery Notes
          action: battery_notes.set_battery_replaced
          data:
            device_id: "{{ trigger.event.data.device_id }}"
            source_entity_id: "{{ trigger.event.data.source_entity_id }}"
        - alias: Maak bevestiging van batterijvervanging
          action: persistent_notification.create
          data:
            title: |
              {{ trigger.event.data.device_name }} Batterij verhoogd
            message: >
              Het apparaat heeft zijn batterijniveau verhoogd, ik heb dit gemarkeerd als vervangen
