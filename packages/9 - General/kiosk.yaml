kiosk_package:
  binary_sensor:
    - platform: tod
      name: Vaatwasser periode
      after: "17:00"
      before: "22:00"
      unique_id: vaatwasser_periode

  input_boolean:
    kiosk_hide_header_and_sidebar:
      name: "Kiosk mode hide header and sidebar"

  input_select:
    kiosk_announcement:
      name: "Kiosk announcement playing"
      options:
        - tafeldekken
        - dinner_time
        - 5min_warning
        - stairs
        - geen
        - maxi
        - mini

  light:
    - platform: group
      name: "Verlichting voor gebruik op kiosk"
      unique_id: groep_verlichting_voor_kiosk
      entities:
        - light.eetkamer_tafel
        - light.spots_eetkamer
        - light.spots_keuken
        - light.spots_vaas
        - light.spots_woonkamer

  script:
    kiosk_restart_browser:
      alias: Restart browser
      description: "Restart all kiosk browsers"
      icon: mdi:web-refresh
      mode: single
      max_exceeded: silent
      sequence:
        - action: button.press
          target:
            entity_id:
              - button.kiosk1_herstart_browser
              - button.kiosk2_herstart_browser

    kiosk_toggle_airco:
      alias: Toggle airco vanaf kiosk
      description: "Schakel de airco om vanaf de kiosk"
      icon: mdi:hvac
      mode: single
      max_exceeded: silent
      sequence:
        - action: climate.set_hvac_mode
          data:
            hvac_mode: >-
              {% if is_state('climate.airco_woonkamer', 'off') %}
                {{ 'heat' if (states('sensor.temp_sensor_7_woonkamer_temperatuur') | float(0)) < 22 else 'cool' }}
              {% else %}
                off
              {% endif %}
          target:
            entity_id: climate.airco_woonkamer

    kiosk_announcement:
      alias: Omroep vanaf de kiosk
      mode: single
      max_exceeded: silent
      fields:
        announcement:
          description: "Welk omroepbericht"
          example: "tafeldekken"
      variables:
        # Map announcements to their messages
        messages:
          tafeldekken: "{{ states('input_select.tafeldekken_beurt') }}, kom je tafel dekken?"
          dinner_time: "Het eten is klaar. Komen jullie naar beneden?"
          5min_warning: "Over 5 minuten is het eten klaar."
          stairs: "Komen jullie naar beneden?"
          maxi: "{{states('input_text.naam_puber')}}, kom je naar beneden?"
          mini: "{{states('input_text.naam_mini')}}, kom je naar beneden?"
        # Map announcements to their speakers
        players:
          tafeldekken: >-
            {%- set child = states('input_select.tafeldekken_beurt')[0] -%}
            {%- if child == 'M' %}media_player.zolder
            {%- elif child == 'T' %}media_player.slaapkamer_t
            {%- else %}media_player.boven{% endif %}
          dinner_time: "media_player.boven"
          5min_warning: "media_player.boven"
          stairs: "media_player.boven"
          maxi: "media_player.zolder"
          mini: "media_player.slaapkamer_t"
        message: "{{ messages.get(announcement, '') }}"
        player: "{{ players.get(announcement, 'media_player.boven') }}"
      sequence:
        - action: input_select.select_option
          target:
            entity_id: input_select.kiosk_announcement
          data:
            option: "{{ announcement }}"
        - alias: "Speel TTS af"
          action: tts.microsoft_say
          data:
            entity_id: "{{ player }}"
            message: "{{ message }}"
        - delay:
            seconds: 5
        - action: input_select.select_option
          target:
            entity_id: input_select.kiosk_announcement
          data:
            option: "geen"

  automation:
    - id: kiosk_screensaver
      alias: "Schakel de screensaver van de kiosks in of uit"
      mode: parallel
      triggers:
        - trigger: state
          entity_id: switch.kiosk1_screensaver
          variables:
            device: kiosk1
            brightness: number.kiosk1_schermhelderheid
            path: "/tsv-dashboards/tsv1"
        - trigger: state
          entity_id: switch.kiosk2_screensaver
          variables:
            device: kiosk2
            brightness: number.kiosk2_schermhelderheid
            path: "/tsv-dashboards/tsv2"
      actions:
        - if: "{{ trigger.to_state.state == 'on' }}"
          then:
            - alias: "Schakel de screensaver in"
              action: browser_mod.navigate
              data:
                path: "/tsv-dashboards/screensaver"
                browser_id:
                  - "{{ device }}"
            - action: number.set_value
              data:
                value: 10
              target:
                entity_id: "{{ brightness }}"
          else:
            - alias: "Schakel de screensaver uit"
              action: browser_mod.navigate
              data:
                path: "{{ path }}"
                browser_id:
                  - "{{ device }}"
            - action: number.set_value
              data:
                value: "{{255 if is_state('sun.sun', 'above_horizon') else 125}}"
              target:
                entity_id: "{{ brightness }}"

    - id: kiosk1_screen
      alias: "Schakel het scherm van kiosk 1 in of uit"
      trigger:
        - alias: "Schakel uit als we de lampen uitzetten"
          trigger: state
          entity_id: light.verlichting_woonkamer
          to: "off"
          id: "turn_off"
        - alias: "Ga sowieso uit om 23:00"
          trigger: time
          at: "23:00:00"
          id: "turn_off"
        - alias: "Ga weer aan om 06:30"
          trigger: time
          at: "06:30:00"
          id: "turn_on"
      actions:
        - if:
            - and:
                - "{{ trigger.id == 'turn_off' }}"
                - condition: time
                  after: "21:00:00"
          then:
            - alias: "Scherm uitschakelen voor de nacht"
              delay: "00:00:10" # Give time for last actions on screen when turning off lights
            - action: homeassistant.turn_off
              data:
                entity_id:
                  - switch.kiosk1_bewegingsdetectie
                  - switch.kiosk1_scherm
          else:
            - if: "{{ trigger.id == 'turn_on' }}"
              then:
                - alias: "Scherm inschakelen"
                  action: homeassistant.turn_on
                  data:
                    entity_id:
                      - switch.kiosk1_bewegingsdetectie
                      - switch.kiosk1_scherm
                - action: homeassistant.turn_off
                  data:
                    entity_id:
                      - switch.kiosk1_screensaver

    - id: kiosk2_screen
      alias: "Schakel het scherm van kiosk 2 in of uit"
      trigger:
        - trigger: numeric_state
          entity_id: sensor.bureau_kantoor_power
          above: 25
          id: "turn_on"
        - trigger: numeric_state
          entity_id: sensor.bureau_kantoor_power
          below: 25
          for: "00:05:00"
          id: "turn_off"
      actions:
        - if: "{{ trigger.id == 'turn_on' }}"
          then:
            - alias: "Scherm inschakelen"
              action: homeassistant.turn_on
              data:
                entity_id:
                  - switch.kiosk2_bewegingsdetectie
                  - switch.kiosk2_scherm
          else:
            - alias: "Scherm uitschakelen"
              action: homeassistant.turn_off
              data:
                entity_id:
                  - switch.kiosk2_bewegingsdetectie
                  - switch.kiosk2_scherm
            - action: homeassistant.turn_off
              data:
                entity_id:
                  - switch.kiosk2_screensaver

    - id: kiosk_restart_browser
      alias: Kiosk herstart browser om 08:45 of bij HA herstart
      triggers:
        - trigger: time
          at: "08:44:30"
        - trigger: homeassistant
          event: start
      actions:
        - delay: "00:00:30" # Prevent race with HA startup & screen on automation
        - action: script.kiosk_restart_browser
