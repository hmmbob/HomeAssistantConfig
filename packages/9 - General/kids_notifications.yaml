kids_notifications_package:
  template:
    - sensor:
        - name: "Snelheid Puber"
          unique_id: maxi_speed
          unit_of_measurement: "km/h"
          state: "{{ (state_attr('device_tracker.schaduwspeler', 'speed') | float(0)) * 3.6 }}"
        - name: "Snelheid Mini"
          unique_id: mini_speed
          unit_of_measurement: "km/h"
          state: "{{ (state_attr('device_tracker.sm_a566b_t', 'speed') | float(0)) * 3.6 }}"

  automation:
    ##########################
    ## Coming home notifications
    ##########################
    - id: notification_kid_left_location
      alias: "Verstuur een melding dat een kind van een locatie vertrekt"
      mode: parallel
      triggers:
        - alias: Mini verlaat school
          trigger: zone
          entity_id: device_tracker.sm_a566b_t
          event: leave
          zone: zone.school
          variables:
            name: "{{states('input_text.naam_mini')}}"
            location: school
        - alias: Mini verlaat MC
          trigger: zone
          entity_id: device_tracker.sm_a566b_t
          event: leave
          zone: zone.mc
          variables:
            name: "{{states('input_text.naam_mini')}}"
            location: MC
        - alias: Mini verlaat scouting
          trigger: zone
          entity_id: device_tracker.sm_a566b_t
          event: leave
          zone: zone.scouting
          variables:
            name: "{{states('input_text.naam_mini')}}"
            location: scouting
        - alias: Puber verlaat school
          trigger: zone
          entity_id: device_tracker.schaduwspeler
          event: leave
          zone: zone.school
          variables:
            name: "{{states('input_text.naam_puber')}}"
            location: school
        - alias: Puber verlaat scouting
          trigger: zone
          entity_id: device_tracker.schaduwspeler
          event: leave
          zone: zone.scouting
          variables:
            name: "{{states('input_text.naam_puber')}}"
            location: scouting
      conditions:
        # Only notify on valid times for each location
        # School: afternoons on weekdays (PE lessons in mornings are offsite)
        # Scouting: Saturdays 12-14 or Mondays 21-22
        - alias: Controleer of vertrektijd binnen meldvenster valt
          or:
            - and:
                - '{{ location == "school" }}'
                - alias: Tijdvenster school op werkdagen 12:00-17:30
                  condition: time
                  after: "12:00:00"
                  before: "17:30:00"
                  weekday:
                    - mon
                    - tue
                    - wed
                    - thu
                    - fri
            - and:
                - '{{ location == "scouting" }}'
                - or:
                    - alias: Tijdvenster scouting op zaterdag 12:00-14:00
                      condition: time
                      after: "12:00:00"
                      before: "14:00:00"
                      weekday:
                        - sat
                    - alias: Tijdvenster scouting op maandag 21:00-22:00
                      condition: time
                      after: "21:00:00"
                      before: "22:00:00"
                      weekday:
                        - mon
      actions:
        - alias: Stuur melding naar volwassenen dat kind onderweg is
          action: notify.mobile_devices_adults
          data:
            title: â™¥ {{ name }} is op weg naar huis!
            message: >
              {{ name }} is rond {{now().strftime("%H:%M")}} van {{ location }} vertrokken.
            data:
              clickAction: "/lovelace-map/map"
              ttl: 0
              priority: high
              notification_icon: mdi:map-marker-radius

    ##########################
    ## Battery level notifications
    ##########################
    - id: notification_kids_battery_low_parents
      alias: "Verstuur een melding dat batterij van kind bijna leeg is"
      mode: parallel
      triggers:
        - alias: Mini batterij daalt onder 15 procent
          trigger: numeric_state
          entity_id: sensor.sm_a566b_t_battery_level
          below: 15
          variables:
            name: "{{states('input_text.naam_mini')}}"
        - alias: Puber batterij daalt onder 15 procent
          trigger: numeric_state
          entity_id: sensor.schaduwspeler_battery_level
          below: 15
          variables:
            name: "{{states('input_text.naam_puber')}}"
      variables:
        target: >
          {% if trigger.entity_id == "sensor.schaduwspeler_battery_level" %}notify.mobile_app_schaduwspeler
          {% elif trigger.entity_id == "sensor.sm_a566b_t_battery_level" %}notify.mobile_app_sm_a566b_t
          {% else %}notify.bogus
          {% endif %}
      conditions:
        # one of these needs to be true to continue
        or:
          - and: # only true if triggered by device and if this device is anywhere but home
              - "{{ trigger.entity_id == 'sensor.schaduwspeler_battery_level' }}"
              - "{{ not is_state('device_tracker.schaduwspeler', 'home') }}"
          - and:
              - "{{ trigger.entity_id == 'sensor.sm_a566b_t_battery_level' }}"
              - "{{ not is_state('device_tracker.sm_a566b_t', 'home') }}"
      actions:
        - alias: Stuur batterijwaarschuwing naar volwassenen
          action: notify.mobile_devices_adults
          data:
            title: ðŸ”‹ Batterijwaarschuwing
            message: >
              De telefoon van {{ name }} is bijna leeg. Updates van zijn locatie zullen snel stoppen.
            data:
              ttl: 0
              priority: high
              notification_icon: mdi:battery-alert-variant
        - alias: Schakel hoge-nauwkeurigheidsmodus uit op doeltelefoon
          action: "{{ target }}"
          data:
            message: "command_high_accuracy_mode"
            data:
              command: "turn_off"
              priority: high
              ttl: 0
        - alias: Stuur batterijwaarschuwing naar telefoon van kind
          action: "{{ target }}"
          data:
            title: ðŸ”‹ Batterijwaarschuwing
            message: >
              Je moet je telefoon even opladen....
            data:
              ttl: 0
              priority: high
              notification_icon: mdi:battery-alert-variant

    ##########################
    ## Turn on high accuracy mode for the kids,
    ## as otherwise updates don't come in regularly enough
    ##########################
    - alias: Schakel high accuracy mode in of uit
      id: kids_turn_gps_on_or_off
      mode: queued
      triggers:
        - alias: Kind tracker gaat naar niet thuis
          trigger: state
          entity_id:
            - device_tracker.schaduwspeler
            - device_tracker.sm_a566b_t
          to:
            - not_home
          id: leave
        - alias: Kind tracker is weer thuis of beschikbaar
          trigger: state
          entity_id:
            - device_tracker.schaduwspeler
            - device_tracker.sm_a566b_t
          not_to:
            - not_home
            - unavailable
          id: enter
      variables:
        target: >
          {% if trigger.entity_id == "device_tracker.schaduwspeler" %}notify.mobile_app_schaduwspeler
          {% elif trigger.entity_id == "device_tracker.sm_a566b_t" %}notify.mobile_app_sm_a566b_t
          {% else %}notify.bogus
          {% endif %}
      actions:
        - alias: Zet hoge-nauwkeurigheidsmodus aan of uit op doeltelefoon
          action: "{{ target }}"
          data:
            message: "command_high_accuracy_mode"
            data:
              command: "{{ 'turn_on' if trigger.id == 'leave' else 'turn_off' }}"
              priority: high
              ttl: 0

  script:
    high_accuracy_mode:
      alias: Schakel high accuracy mode in of uit
      mode: queued
      fields:
        target:
          name: "Doel"
          description: "Welk apparaat"
          required: true
          selector:
            select:
              options:
                - label: Maxi
                  value: notify.mobile_app_schaduwspeler
                - label: Mini
                  value: notify.mobile_app_sm_a566b_t
      variables:
        command: >-
          {% if target == 'notify.mobile_app_schaduwspeler' %}
            {{ 'turn_off' if is_state('binary_sensor.schaduwspeler_high_accuracy_mode', 'on') else 'turn_on' }}
          {% elif target == 'notify.mobile_app_sm_a566b_t' %}
            {{ 'turn_off' if is_state('binary_sensor.sm_a566b_t_high_accuracy_mode', 'on') else 'turn_on' }}
          {% endif %}
      sequence:
        alias: Verstuur high-accuracy-commando naar geselecteerde telefoon
        action: "{{ target }}"
        data:
          message: "command_high_accuracy_mode"
          data:
            command: "{{ command }}"
            priority: high
            ttl: 0
