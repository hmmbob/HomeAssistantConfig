airco_package:
  input_datetime:
    time_turn_off_airco_livingroom:
      name: Airco woonkamer uit
      has_time: true

  timer:
    airco_mini_sleeptimer:
      name: "Airco sleeptimer mini"
      restore: true
    airco_puber_sleeptimer:
      name: "Airco sleeptimer puber"
      restore: true

  automation:
    ###########################################
    ## Sleeptimer voor airco's van kinderen   #
    ###########################################
    - id: airco_kinderen_start_on_timer_start
      alias: "Start de airco van de kinderen als de timer start"
      description: "Zet de airco aan als de timer start"
      triggers:
        - alias: Airco mini sleeptimer is gestart
          trigger: event
          event_type: timer.started
          event_data:
            entity_id: timer.airco_mini_sleeptimer
          variables:
            airco: climate.airco_slaapkamer_t
            temp_sensor: sensor.xiaomi_temperature_humidity_sensor_3_temperature
        - alias: Airco puber sleeptimer is gestart
          trigger: event
          event_type: timer.started
          event_data:
            entity_id: timer.airco_puber_sleeptimer
          variables:
            airco: climate.airco_slaapkamer_m
            temp_sensor: sensor.temp_sensor_8_slaapkamer_m_temperatuur
      actions:
        - alias: Stel modus in voor kinderairco op basis van kamertemperatuur
          action: climate.set_hvac_mode
          target:
            entity_id: "{{airco}}"
          data:
            hvac_mode: "{{ 'heat' if (states(temp_sensor) | float(0)) < 21 else 'cool' }}"

    - id: airco_sleeptimer_kinderen
      alias: "Sleeptimer voor de airco's van de kinderen"
      description: "Zet de airco uit aan het einde van de timer"
      triggers:
        - alias: Airco mini sleeptimer is afgelopen
          trigger: event
          event_type: timer.finished
          event_data:
            entity_id: timer.airco_mini_sleeptimer
          variables:
            entity: climate.airco_slaapkamer_t
        - alias: Airco puber sleeptimer is afgelopen
          trigger: event
          event_type: timer.finished
          event_data:
            entity_id: timer.airco_puber_sleeptimer
          variables:
            entity: climate.airco_slaapkamer_m
      actions:
        - alias: Zet geselecteerde kinderairco uit na afloop sleeptimer
          action: climate.set_hvac_mode
          target:
            entity_id: "{{entity}}"
          data:
            hvac_mode: "off"

    ###########################################
    ## Automatisch uitschakelen van airco's   #
    ###########################################
    - id: airco_automatisch_uit
      alias: "Zet airco automatisch uit einde avond"
      description: "Schakel airco's automatisch uit zodat we het niet vergeten"
      triggers:
        - alias: Dagelijks om 23:00 voor uitschakelen kinderairco's
          trigger: time
          at: "23:00:00"
          variables:
            target: airco_children
        - alias: Ingestelde uitschakeltijd woonkamerairco bereikt
          trigger: time
          at: input_datetime.time_turn_off_airco_livingroom
          variables:
            target: climate.airco_woonkamer
        - alias: "Lampen in woonkamer zijn uit"
          trigger: state
          entity_id: light.verlichting_woonkamer
          to: "off"
          id: "lights_turned_off"
          variables:
            target: climate.airco_woonkamer
      actions:
        - alias: Kies uitschakelactie op basis van doelairco
          choose:
            - conditions: "{{ target == 'airco_children' }}"
              sequence:
                - alias: Controleer of mini-sleeptimer niet actief is
                  if:
                    - "{{ states('timer.airco_mini_sleeptimer') != 'active' }}"
                  then:
                    - alias: Zet airco op slaapkamer T uit
                      action: climate.set_hvac_mode
                      target:
                        entity_id: climate.airco_slaapkamer_t
                      data:
                        hvac_mode: "off"
                - alias: Controleer of puber-sleeptimer niet actief is
                  if:
                    - "{{ states('timer.airco_puber_sleeptimer') != 'active' }}"
                  then:
                    - alias: Zet airco op slaapkamer M uit
                      action: climate.set_hvac_mode
                      target:
                        entity_id: climate.airco_slaapkamer_m
                      data:
                        hvac_mode: "off"
            - conditions: "{{ target == 'climate.airco_woonkamer' }}"
              sequence:
                - alias: Controleer of woonkamerairco uit mag bij lampen uit
                  if:
                    - "{{ trigger.id == 'lights_turned_off' }}"
                    - not:
                        - alias: Controleer dat het na 21:00 is
                          condition: time
                          after: "21:00:00"
                  then:
                    - alias: Zet woonkamerairco uit
                      action: climate.set_hvac_mode
                      target:
                        entity_id: "{{target}}"
                      data:
                        hvac_mode: "off"

    - id: turn_off_when_away
      alias: "Zet de airco en verwarming uit als we weg zijn"
      description: "Klimaat: Schakel verwarming uit als we weg zijn"
      triggers:
        - alias: Niet thuis gedurende 30 minuten
          trigger: state
          entity_id: zone.home
          to: "0"
          for:
            minutes: 30
      actions:
        - alias: "Schakel Tado-apparaten uit die aan staan (laat anderen in huidige staat)"
          action: climate.set_hvac_mode
          data:
            hvac_mode: auto
          target:
            entity_id: "{{ integration_entities('tado') | select('is_state', 'heat') | list }}"
        - alias: "Schakel airco's uit"
          action: climate.set_hvac_mode
          data:
            hvac_mode: "off"
          target:
            entity_id:
              - climate.airco_master_bedroom
              - climate.airco_slaapkamer_m
              - climate.airco_slaapkamer_t
              - climate.airco_woonkamer

    ###########################################
    ## Limiteer setpoint van airco's kinderen #
    ###########################################
    - id: airco_kinderen_limit_setpoint
      alias: "Zet airco kinderen automatisch op een normale temperatuur"
      description: "Stel de airco van de kinderen automatisch in op een normale temperatuur (ter voorkoming van gebruikersfouten en energiebesparing)"
      triggers:
        - alias: Setpoint van kinderairco gewijzigd
          trigger: state
          entity_id:
            - climate.airco_slaapkamer_m
            - climate.airco_slaapkamer_t
          attribute: temperature
      variables:
        current_mode: "{{ states(trigger.entity_id) }}"
        set_temp: "{{ state_attr(trigger.entity_id, 'temperature') | float(0) }}"
      actions:
        - alias: Corrigeer setpoint buiten toegestane bandbreedte
          choose:
            - conditions: "{{ current_mode in ['cool', 'dry'] and set_temp < 20 }}"
              sequence:
                - alias: Verhoog koel-/droogsetpoint naar 22 graden
                  action: climate.set_temperature
                  target:
                    entity_id: "{{ trigger.entity_id }}"
                  data:
                    temperature: 22
            - conditions: "{{ current_mode == 'heat' and set_temp > 22 }}"
              sequence:
                - alias: Verlaag verwarmingssetpoint naar 22 graden
                  action: climate.set_temperature
                  target:
                    entity_id: "{{ trigger.entity_id }}"
                  data:
                    temperature: 22
