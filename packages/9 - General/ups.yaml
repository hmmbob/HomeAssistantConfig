ups_package:
  automation:
    - id: ups_notification
      alias: "Verstuur een melding als we op de UPS draaien"
      mode: single
      max_exceeded: silent
      triggers:
        - trigger: state
          entity_id:
            - sensor.ups_battery_charge
            - sensor.ups_status_data
      variables:
        runtime_left: >
          {% set runtime = states("sensor.ups_battery_runtime") | int %}
          {% set hours = runtime // 3600 %}
          {% set minutes = (runtime % 3600) // 60 %}
          {{ '%du' % hours if hours else '' }}{{ '%dm' % minutes if minutes else '' }}
      conditions:
        - alias: "Previous state of triggers is not unavailable or unkown"
          condition: template
          value_template: "{{ trigger.from_state.state not in ['unavailable', 'unknown'] }}"
      actions:
        - alias: "Kies onze status"
          choose:
            - conditions:
                - alias: "If we are On Battery DISCHaRGing"
                  condition: state
                  entity_id: sensor.ups_status_data
                  state: "OB DISCHRG"
              sequence:
                - alias: "We're running on battery!"
                  action: notify.mobile_app_sm_a556b
                  data:
                    title: ðŸª« UPS ingeschakeld!
                    message: >
                      De servers draaien op UPS. Er is nog  {{ runtime_left }} runtime over.
                    data:
                      tag: "UPS"
                      alert_once: true
                      sticky: true
                      persistent: true
                      ttl: 0
                      priority: high
                      notification_icon: mdi:home-battery-outline
                      car_ui: true
            - conditions:
                - alias: "If we are On Line CHaRGing"
                  condition: state
                  entity_id: sensor.ups_status_data
                  state: "OL CHRG"
              sequence:
                - alias: "We're back online, charging the UPS battery!"
                  action: notify.mobile_app_sm_a556b
                  data:
                    title: ðŸ”‹ UPS weer online & aan het opladen!
                    message: >
                      Er is weer stroom. De UPS laadt weer op en is {{ states("sensor.ups_battery_charge") }}% vol.
                    data:
                      tag: "UPS"
                      alert_once: true
                      sticky: true
                      persistent: true
                      ttl: 0
                      priority: high
                      notification_icon: mdi:power-plug-battery-outline
                      car_ui: true
            - conditions:
                - alias: "If we are back OnLine"
                  condition: state
                  entity_id: sensor.ups_status_data
                  state: "OL"
              sequence:
                - action: notify.mobile_app_sm_a556b
                  data:
                    message: "clear_notification"
                    data:
                      tag: "UPS"

    - id: warn_for_power_fail
      alias: "Stuur notificatie als een van de fases wegvalt"
      description: "Waarschuw als een van de elektriciteitsfasen uitvalt"
      mode: parallel
      triggers:
        - trigger: state
          entity_id:
            - binary_sensor.slimmelezer_power_failure_phase_1
            - binary_sensor.slimmelezer_power_failure_phase_2
            - binary_sensor.slimmelezer_power_failure_phase_3
          to: "on"
          from: "off"
      conditions: []
      actions:
        - alias: "Stroomuitval"
          action: notify.mobile_app_sm_a556b
          data:
            title: Stroomuitval
            message: >
              {{ state_attr(trigger.entity_id, 'friendly_name') }}
            data:
              tag: "power_failure"
              ttl: 0
              priority: high
              notification_icon: mdi:transmission-tower-off
              car_ui: true
