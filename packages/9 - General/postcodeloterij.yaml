postcodeloterij_package:
  rest:
    - resource_template: !secret postcodeloterij_url
      scan_interval: 43200
      headers:
        User-Agent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36"
      sensor:
        - name: Postcodeloterij aantal prijzen
          unique_id: postcodeloterij_aantal_prijzen
          value_template: "{{ value_json.prizeCount }}"
        - name: Postcodeloterij prijzen
          unique_id: postcodeloterij_prijzen
          value_template: >
            {% set ns = namespace(prizes=[]) %}
            {% for p in value_json.wonPrizes %}
              {% set ns.prizes = ns.prizes + [p.description ~ ' (â‚¬ ' ~'{:.2f}'.format(p.prizeValue / 100) ~ ')'] %}
            {% endfor %}
            {{ ns.prizes | join(', ') if ns.prizes else 'Helaas, pindakaas' }}

  automation:
    - id: postcodeloterij_winners_notification
      alias: "Postcodeloterij: Gewonnen!"
      mode: single
      max_exceeded: silent
      description: Send a notification when we win something in de Postcodeloterij
      trigger:
        - platform: state
          entity_id: sensor.postcodeloterij_aantal_prijzen
          not_to:
            - "0"
            - unavailable
            - unknown
      action:
        - alias: "Send notification"
          service: notify.mobile_devices_adults
          data:
            title: "ðŸ† Winnen doe je bij..."
            message: >
              {% set p = trigger.to_state.state | int %}
              {% set m = 'prijs' if p == 1 else p ~ ' prijzen' %}
              {% set prizes = states("sensor.postcodeloterij_prijzen") %}
              We hebben {{ m }} in de Postcodeloterij: {{ prizes }}
            data:
              channel: LotteryPrize
              ttl: 0
              priority: high
              notification_icon: mdi:trophy
              tag: LotteryPrize
