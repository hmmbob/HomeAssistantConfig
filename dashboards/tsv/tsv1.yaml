title: TSV 1
path: tsv1
theme: Hmmbob dark theme
type: custom:vertical-layout
layout:
  width: 500

cards:
  - type: grid
    columns: 2
    square: false
    cards:
      - !include common/weather-card.yaml
      - type: custom:mushroom-chips-card
        alignment: end
        chips:
          - !include common/chip-knmi_temp.yaml

          - type: entity
            entity: sensor.temp_sensor_7_woonkamer_temperatuur
            icon: mdi:home-thermometer
            tap_action:
              action: none
            card_mod:
              style: |
                ha-card {
                  --chip-background: transparent;
                  --chip-border-color: transparent;
                  --chip-box-shadow: none;
                }

          - !include common/chip-fan.yaml
          - !include common/chip-cctv.yaml
          - !include common/chip-omroep.yaml

  - type: grid
    columns: 2
    square: false
    cards:
      - type: vertical-stack
        cards:
          - !include common/button-lights.yaml
          - type: custom:swipe-card
            parameters:
              effect: fade
              autoplay:
                delay: 5000
                disableOnInteraction: false
              rewind: true
              slidesPerView: 1
            cards:
              - type: conditional
                conditions:
                  - condition: state
                    entity: binary_sensor.vaatwasser_periode
                    state: "on"
                card:
                  type: custom:mushroom-template-card
                  primary: Vaatwasser
                  secondary: "Het beste start je de vaatwasser om {{states('sensor.vaatwasser_goedkoopste_tijd')}}"
                  icon: mdi:dishwasher
                  icon_color: green
              - type: conditional
                condition: and
                conditions:
                  - condition: state
                    entity: sensor.afvalinfo_home_vandaag
                    state_not: "geen"
                  - condition: state
                    entity: binary_sensor.vaatwasser_periode
                    state: "off"
                card:
                  type: custom:mushroom-template-card
                  entity: sensor.afvalinfo_home_vandaag
                  primary: >-
                    Vandaag wordt het {{ states(entity)|lower if (states(entity)|length > 3) 
                      else states(entity) }} opgehaald
                  icon: mdi:trash-can
                  icon_color: |-
                    {% if is_state('sensor.afvalinfo_home_vandaag', 'GFT') %}
                      green
                    {% elif is_state('sensor.afvalinfo_home_vandaag', 'PBD') %}
                      orange
                    {% elif is_state('sensor.afvalinfo_home_vandaag', 'Papier') %}
                      blue
                    {% elif is_state('sensor.afvalinfo_home_vandaag', 'Restafval') %}
                      red
                    {% else %}
                      dark-grey
                    {% endif %}
                  tap_action:
                    action: none
              - type: conditional
                conditions:
                  - condition: state
                    entity: sensor.afvalinfo_home_morgen
                    state_not: "geen"
                card:
                  type: custom:mushroom-template-card
                  entity: sensor.afvalinfo_home_morgen
                  primary: >-
                    Morgen wordt het {{ states(entity)|lower if (states(entity)|length > 3) 
                      else states(entity) }} opgehaald
                  icon: mdi:trash-can
                  icon_color: |-
                    {% if is_state('sensor.afvalinfo_home_morgen', 'GFT') %}
                      green
                    {% elif is_state('sensor.afvalinfo_home_morgen', 'PBD') %}
                      orange
                    {% elif is_state('sensor.afvalinfo_home_morgen', 'Papier') %}
                      blue
                    {% elif is_state('sensor.afvalinfo_home_morgen', 'Restafval') %}
                      red
                    {% else %}
                      dark-grey
                    {% endif %}
                  tap_action:
                    action: none
              - type: conditional
                condition: and
                conditions:
                  - condition: state
                    entity: sensor.afvalinfo_home_vandaag
                    state: "geen"
                  - condition: state
                    entity: sensor.afvalinfo_home_morgen
                    state: "geen"
                card:
                  type: custom:mushroom-template-card
                  primary: "Volgende inzameling"
                  secondary: "{{states('sensor.afval_info_volgende_inzameling_en_datum')}}"
                  icon: mdi:trash-can
                  icon_color: dark-grey
                  tap_action:
                    action: none

          - type: "custom:vertical-stack-in-card"
            card_mod:
              style: |
                ha-card { height: 55px !important; }
            cards:
              - type: custom:mushroom-climate-card
                entity: climate.airco_woonkamer
                show_temperature_control: true
                layout: horizontal
                hold_action:
                  action: perform-action
                  perform_action: script.kiosk_toggle_airco
                tap_action:
                  action: fire-dom-event
                  browser_mod:
                    service: browser_mod.more_info
                    data:
                      entity: climate.airco_woonkamer
              - type: custom:mushroom-template-card
                icon: mdi:power
                color: >-
                  {% if is_state('climate.airco_woonkamer', 'off') %}
                    {{ 'orange' 
                      if (states('sensor.temp_sensor_7_woonkamer_temperatuur') | float(0)) < 22 
                      else 'blue' }}
                  {% else %}
                    'red'
                  {% endif %}
                card_mod:
                  style:
                    .: |
                      ha-card {
                        background: none;
                        margin-left: 185px;
                        top: -53px;
                        width: 50px;
                      }
                icon_tap_action:
                  action: perform-action
                  perform_action: script.kiosk_toggle_airco

          - !include common/kids-devices.yaml

          - type: custom:plotly-graph
            # title: Electriciteitsprijs
            hours_to_show: 18
            time_offset: 17h
            fn: |
              $fn ({ hass, vars }) => {
                vars.x = []; vars.y = []; vars.color = []; vars.hover = [];
                vars.min = {p: 999,t: null}; vars.max = {p:-999,t:null}
                vars.ymin = 999; vars.ymax = -999
                vars.p_now = parseFloat(hass.states['sensor.zonneplan_current_electricity_tariff'].state)
                vars.unit_of_measurement = hass.states['sensor.zonneplan_current_electricity_tariff'].attributes.unit_of_measurement
                const cutoff = Date.now() - 3600000;
                hass.states['sensor.zonneplan_current_electricity_tariff']?.attributes?.forecast?.map(e => {
                  var t = new Date(e.datetime).getTime()+1800000 
                  if (t < cutoff) return;
                  var p = e.electricity_price/10000000
                  var c = e.tariff_group.replace("low", "#00a964").replace("normal", "#227153").replace("high","#ed5e18")
                  if (t>=Date.now()-1800000) {
                    if (p<vars.min.p) vars.min = {p,t,c}
                    if (p>vars.max.p) vars.max = {p,t,c}
                  }
                  if (p<vars.ymin) vars.ymin = p
                  if (p>vars.ymax) vars.ymax = p
                  vars.x.push(t)
                  vars.y.push(p)
                  vars.color.push(c)
                  vars.hover.push(String(new Date(t).getHours()).padStart(2,"0") + ":00-" + 
                    String(new Date((new Date(t).getTime()+3600000)).getHours()).padStart(2,"0") + ":00 : <b>" + 
                    p.toFixed(3) + "</b> " + vars.unit_of_measurement)
                })
                console.log(vars)
              }
            layout:
              height: 100
              yaxis:
                fixedrange: true
                tickformat: .2f
                range: $fn ({vars}) => [ vars.ymin-0.02, vars.ymax+0.02 ]
              xaxis:
                tickformat: "%H:%M"
                # range: $fn () => [ Date.now() - 3600000, Date.now() + (12 * 3600000) ]
            config:
              displayModeBar: false
            entities:
              - entity: "" # Price columns
                unit_of_measurement: $ex vars.unit_of_measurement
                name: ""
                showlegend: false
                x: $ex vars.x
                "y": $ex vars.y
                marker:
                  color: $ex vars.color
                type: bar
                hovertemplate: $ex vars.hover
              - entity: "" # MIN marker + legend
                mode: markers
                textposition: top
                showlegend: false
                name: >-
                  $fn ({vars}) => vars.min.p.toFixed(3) + " " + vars.unit_of_measurement + "
                  @ " + new Date(vars.min.t).getHours() + ":00"
                yaxis: y0
                marker:
                  symbol: diamond
                  color: $ex vars.min.c
                x:
                  - $ex vars.min.t
                "y":
                  - $ex vars.min.p
              - entity: "" # MAX marker + legend
                mode: markers
                textposition: top
                showlegend: false
                name: >-
                  $fn ({vars}) => vars.max.p.toFixed(3) + " " + vars.unit_of_measurement + "
                  @ " +  new Date(vars.max.t).getHours() + ":00"
                yaxis: y0
                marker:
                  symbol: diamond
                  color: $ex vars.max.c
                x:
                  - $ex vars.max.t
                "y":
                  - $ex vars.max.p
              - entity: "" # NOW Line
                name: Now
                yaxis: y0
                showlegend: false
                line:
                  width: 2
                  dash: dot
                  color: deepskyblue
                x: $ex [Date.now(), Date.now()]
                "y":
                  - 0
                  - 1
              - entity: "" # NOW Legend
                yaxis: y0
                mode: markers
                textposition: top
                showlegend: false
                name: >-
                  $fn ({vars}) => "Nu: " + vars.p_now.toFixed(3) + " " + vars.unit_of_measurement
                marker:
                  symbol: diamond
                  color: deepskyblue
                x: $ex [Date.now(), Date.now()]
                "y":
                  - $ex vars.p_now

      ### Right column
      - type: custom:calendar-card-pro
        entities:
          - entity: calendar.bl
            accent_color: "#0911e8"
            blocklist: "restafval|gft|plasticinzameling"
          #- entity: calendar.bv
          #  accent_color: "#f266eb"
          - entity: calendar.m
            accent_color: "#8607f5"
          - entity: calendar.t
            accent_color: "#20572f"
          - entity: calendar.familie
            accent_color: "#d98b04"
            allowlist: "verjaardag|trouwdag" # Celebration events
            label: "ðŸŽ‰" # Add celebration label to these events
          - entity: calendar.familie
            accent_color: "#d98b04"
            allowlist: "Picnic|Jumbo" # Grocery delivery events
            label: "ðŸ›’" # Add shopping cart
          - entity: calendar.familie
            accent_color: "#f266eb" # Apply pinks color to wife's work schedule
            allowlist: "B[a-zA-Z]{5}\\s(vrij|werken)"
          - entity: calendar.familie
            accent_color: "#d98b04" # Exclude everything included above
            blocklist: "tafel dekken|vakantie|verjaardag|trouwdag|B[a-zA-Z]{5}\\s(vrij|werken)|Picnic"
        date_vertical_alignment: top
        day_font_size: "24px"
        day_separator_color: "#03a9f430"
        day_separator_width: "1px"
        days_to_show: 3
        event_background_opacity: 40
        event_font_size: "13px"
        event_spacing: 6px
        filter_duplicates: true
        first_day_of_week: monday
        refresh_interval: 10
        show_location: false
        show_single_allday_time: false
        split_multiday_events: true
        today_indicator: glow
        today_indicator_position: "7px 27px"
        vertical_line_width: 5px
        card_mod: # Show time inline
          style: |
            div.event-content {
              display: grid;
              grid-template-areas: 
                "title time"
                "location location";
              grid-template-columns: 1fr auto;
              column-gap: 10px;
              row-gap: 0px;
            }
            div.summary {
              grid-area: title;
              overflow: hidden;
              text-overflow: ellipsis;
            }
            div.time {
              grid-area: time;
              white-space: nowrap;
            }
            div.location {
              grid-area: location;
              white-space: normal;
              overflow: hidden;
              text-overflow: ellipsis;
            }
            div.time-location {
              display: contents;
            }
        tap_action:
          action: navigate
          navigation_path: /tsv-dashboards/calendar
