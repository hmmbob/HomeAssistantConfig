####################
# Energy             #
####################
path: energy
title: Energieverbruik
icon: mdi:home-lightning-bolt
cards:
  - type: vertical-stack
    cards:
      - type: markdown ## Energieverbruik header
        content: |
          # Energie
        card_mod:
          style:
            .: |
              ha-card {
                margin: 12px 14px -5px 14px;
                box-shadow: none;
                --ha-card-background: rgba(0, 0, 0, 0.0)
              }
            ha-markdown$: |
              h1 { 
                font-size: 18px !important;
                font-weight: 400 !important;
                padding-left: 10px !important;
                border-left: 3px solid rgba(81, 134, 236);
                }

      - type: tile
        entity: sensor.zonneplan_status_tip
        color: green
        show_entity_picture: false
        icon: mdi:head-lightbulb-outline
        name: Zonneplan advies

      - type: custom:mushroom-template-card
        primary: >-
          Huidige prijs: €{{"%0.2f" | format(states('sensor.zonneplan_current_electricity_tariff') | float) }}
        secondary: |-
          {% set mapping = dict(low="goedkoop", normal="gemiddeld", high="duur") %}
          {{ now().hour }}:00 - {{ now().hour+1 }}:00. Stroom is nu 
          {{ mapping[states('sensor.zonneplan_current_tariff_group')] }}.
        icon: mdi:currency-eur
        entity: sensor.zonneplan_current_electricity_tariff
        icon_color: |-
          {% if is_state("sensor.zonneplan_current_tariff_group", "low") -%}
            green
          {%- elif is_state("sensor.zonneplan_current_tariff_group", "normal") -%}
            orange
          {%- elif is_state("sensor.zonneplan_current_tariff_group", "high") -%}
            red
          {%- endif %}
        badge_icon: |-
          {% set mapping = dict(low=1, normal=2, high=3) %}
          {% set current = states('sensor.zonneplan_current_tariff_group') %}
          {% set forecast = states('sensor.zonneplan_forcast_tariff_group_hour_1') %}
          {% set available = current in mapping.keys() and forecast in mapping.keys() %}
          {% if available and mapping[forecast] > mapping[current] %}
            mdi:arrow-top-right-thick
          {% elif available and mapping[forecast] < mapping[current] %}
            mdi:arrow-bottom-right-thick
          {% elif available %}
            mdi:arrow-right-bold
          {% endif %}
        badge_color: |-
          {% set mapping = dict(low=1, normal=2, high=3) %}
          {% set current = states('sensor.zonneplan_current_tariff_group') %}
          {% set forecast = states('sensor.zonneplan_forcast_tariff_group_hour_1') %}
          {% set available = current in mapping.keys() and forecast in mapping.keys() %}
          {% if available and mapping[forecast] > mapping[current] %}
            red
          {% elif available and mapping[forecast] < mapping[current] %}
            green
          {% elif available %}
            blue
          {% endif %}

      - type: horizontal-stack
        cards:
          - type: custom:mushroom-template-card
            primary: "Laagste prijs: €{{'%0.2f' | format(states('sensor.zonneplan_goedkoopste_prijs') | float) }}"
            secondary: >-
              {{ as_local(as_datetime(state_attr('sensor.zonneplan_goedkoopste_prijs',
                'datetime'))).strftime('%d-%m %-H:%M')}} - 
              {{ (as_local(as_datetime(state_attr('sensor.zonneplan_goedkoopste_prijs',
                'datetime'))).strftime('%-H')|int)+1}}:00
            icon: mdi:currency-eur
            entity: sensor.zonneplan_goedkoopste_prijs
            icon_color: green
          - type: custom:mushroom-template-card
            primary: "Hoogste prijs: €{{'%0.2f' | format(states('sensor.zonneplan_duurste_prijs') | float) }}"
            secondary: >-
              {{ as_local(as_datetime(state_attr('sensor.zonneplan_duurste_prijs',
                'datetime'))).strftime('%d-%m %-H:%M')}} - 
              {{ (as_local(as_datetime(state_attr('sensor.zonneplan_duurste_prijs',
                'datetime'))).strftime('%-H')|int)+1}}:00
            icon: mdi:currency-eur
            entity: sensor.zonneplan_duurste_prijs
            icon_color: red

      - type: custom:apexcharts-card
        config_templates:
          - energy
          - electricity
        header:
          title: Electriciteitsprijs
        span:
          start: hour
        now:
          show: true
          label: Nu
        series:
          - entity: sensor.zonneplan_current_electricity_tariff
            name: "Dynamische energieprijs"
            data_generator: |
              return entity.attributes.forcast.map((start, index) => {
                return [new Date(start["datetime"]).getTime() + 1800000, 
                        (entity.attributes.forcast[index]["electricity_price"] / 10000000).toFixed(2) ];
                }
              );

      - type: custom:apexcharts-card
        config_templates:
          - energy
          - gas
        header:
          title: Gasprijs vandaag
        series:
          - entity: sensor.zonneplan_gasprijs
            group_by:
              duration: 1d
              func: last
        apex_config:
          annotations:
            yaxis:
              - y: "1.45"
                label:
                  text: "Energieplafond"
                  position: "left"
                  offsetX: 75
                  style:
                    background: rgb(26, 115, 232)
                    color: "#fff"
                  borderColor: "#fff"

      - type: entities
        entities:
          - entity: sensor.dsmr_reading_electricity_currently_delivered
            name: "Huidig verbruik gecombineerd"
            icon: mdi:power-plug
          - type: divider
          - type: custom:multiple-entity-row
            entity: sensor.dsmr_day_consumption_electricity_cost_merged
            show_state: false
            name: "Dagverbruik electra"
            icon: "mdi:home-lightning-bolt"
            entities:
              - entity: sensor.dsmr_day_consumption_electricity_merged
                name: "Verbruik"
                format: precision1
              - entity: sensor.dsmr_day_consumption_electricity_cost_merged
                name: "Kosten"
          - type: custom:multiple-entity-row
            entity: sensor.dsmr_day_consumption_gas
            show_state: false
            name: "Dagverbruik gas"
            entities:
              - entity: sensor.dsmr_day_consumption_gas
                name: "Verbruik"
                format: precision1
              - entity: sensor.dsmr_day_consumption_gas_cost
                name: "Kosten"
          - type: custom:multiple-entity-row
            entity: sensor.dsmr_day_consumption_total_cost
            show_state: false
            name: "Energiekosten vandaag"
            entities:
              - entity: sensor.dsmr_day_consumption_fixed_cost
                name: "Vaste kosten"
              - entity: sensor.dsmr_day_consumption_total_cost
                name: "Totaal vandaag"

          - type: divider
          - type: custom:multiple-entity-row
            entity: sensor.dsmr_current_month_electricity_cost_merged
            show_state: false
            name: "Maandverbruik electra"
            icon: "mdi:home-lightning-bolt"
            entities:
              - entity: sensor.dsmr_current_month_electricity_merged
                name: "Verbruik"
                format: precision1
              - entity: sensor.dsmr_current_month_electricity_cost_merged
                name: "Kosten"
          - type: custom:multiple-entity-row
            entity: sensor.dsmr_current_month_gas
            show_state: false
            name: "Maandverbruik gas"
            entities:
              - entity: sensor.dsmr_current_month_gas
                name: "Verbruik"
                format: precision1
              - entity: sensor.dsmr_current_month_gas_cost
                name: "Kosten"
          - type: custom:multiple-entity-row
            entity: sensor.dsmr_current_month_total_cost
            show_state: false
            name: "Energiekosten deze maand"
            entities:
              - entity: sensor.dsmr_current_month_fixed_cost
                name: "Vaste kosten"
              - entity: sensor.dsmr_current_month_total_cost
                name: "Totaal deze maand"
